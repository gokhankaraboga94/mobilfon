


<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kurumsal Onay ve ƒ∞≈ülem Y√∂netim Sistemi</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --secondary: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            --success: #22c55e;
            --dark: #1f2937;
            --light: #f3f4f6;
            --border: #e5e7eb;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: var(--shadow-lg);
            width: 100%;
            max-width: 1400px;
            overflow: hidden;
        }

        .login-container {
            max-width: 450px;
            padding: 50px;
        }

        .logo {
            text-align: center;
            margin-bottom: 30px;
        }

        .logo h1 {
            color: var(--primary);
            font-size: 32px;
            margin-bottom: 10px;
        }

        .logo p {
            color: #6b7280;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: var(--dark);
            font-weight: 600;
            font-size: 14px;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        button {
            width: 100%;
            padding: 14px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        button:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }

        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 16px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
        }

        .navbar-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .navbar-brand {
            font-size: 20px;
            font-weight: 700;
        }

        .search-box {
            position: relative;
        }

        .search-box input {
            padding: 8px 16px 8px 40px;
            border-radius: 20px;
            border: none;
            width: 300px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .search-box input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: white;
        }

        .navbar-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logout-btn {
            padding: 8px 20px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid white;
            color: white;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            width: auto;
        }

        .logout-btn:hover {
            background: white;
            color: var(--primary);
        }

        .dashboard {
            padding: 30px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--border);
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            color: #6b7280;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            width: auto;
        }

        .tab:hover {
            color: var(--primary);
            transform: none;
        }

        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--dark);
        }

        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            width: auto;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: var(--light);
        }

        th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: var(--dark);
            border-bottom: 2px solid var(--border);
            white-space: nowrap;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid var(--border);
        }

        tr:hover {
            background: #f9fafb;
        }

        .badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }

        .badge-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-approved {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-rejected {
            background: #fee2e2;
            color: #991b1b;
        }

        .badge-completed {
            background: #dbeafe;
            color: #1e40af;
        }

        .badge-progress {
            background: #e0e7ff;
            color: #3730a3;
        }

        .badge-admin {
            background: #fce7f3;
            color: #9f1239;
        }

        .badge-user {
            background: #dbeafe;
            color: #1e40af;
        }

        .badge-cost-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-cost-paid {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-linked {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #16a34a;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: var(--shadow);
        }

        .stat-number {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border-left: 4px solid #10b981;
        }

        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border-left: 4px solid #ef4444;
        }

        .alert-info {
            background: #dbeafe;
            color: #1e40af;
            border-left: 4px solid #3b82f6;
        }

        .hidden {
            display: none !important;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 6px 12px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .col {
            flex: 1;
        }

        @media (max-width: 768px) {
            .navbar {
                flex-direction: column;
                gap: 15px;
            }

            .search-box input {
                width: 100%;
            }

            .tabs {
                overflow-x: auto;
            }

            .grid {
                grid-template-columns: 1fr;
            }

            .row {
                flex-direction: column;
            }
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .editable-select {
            position: relative;
        }

        .editable-options {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid var(--border);
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            display: none;
            z-index: 100;
        }

        .editable-options.active {
            display: block;
        }

        .option-item {
            padding: 10px 16px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .option-item:hover {
            background: var(--light);
        }

        .add-option {
            padding: 10px 16px;
            background: var(--light);
            border-top: 1px solid var(--border);
            display: flex;
            gap: 10px;
        }

        .add-option input {
            flex: 1;
            padding: 6px 12px;
        }

        .add-option button {
            padding: 6px 12px;
            width: auto;
        }

        .cost-info {
            background: #fef3c7;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #f59e0b;
        }

        .cost-info strong {
            color: #92400e;
        }

        .info-box {
            background: #dbeafe;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #3b82f6;
        }

        .info-box h4 {
            color: #1e40af;
            margin-bottom: 10px;
        }

        .info-box p {
            color: #1e40af;
            font-size: 14px;
            line-height: 1.6;
        }

        .info-box-warning {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
        }

        .info-box-warning h4 {
            color: #92400e;
        }

        .info-box-warning p {
            color: #92400e;
        }

        .info-box-success {
            background: #dcfce7;
            border-left: 4px solid #16a34a;
        }

        .info-box-success h4 {
            color: #166534;
        }

        .info-box-success p {
            color: #166534;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            animation: slideIn 0.3s;
        }

        .modal-header {
            font-size: 20px;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 15px;
        }

        .modal-body {
            color: #6b7280;
            margin-bottom: 25px;
            line-height: 1.6;
        }

        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .modal-footer button {
            width: auto;
            padding: 10px 24px;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .linked-indicator {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 8px;
            background: #dcfce7;
            border-radius: 6px;
            font-size: 11px;
            color: #166534;
            font-weight: 600;
            margin-left: 8px;
        }
    </style>

<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
<script type="text/javascript">
   (function(){
      // BURAYA EmailJS'den aldƒ±ƒüƒ±n Public Key'i yaz
      emailjs.init("wOBxpRyC1mGP3GIvQ");
   })();
</script>




</head>
<body>
    <div class="container" id="app">
        <!-- Login Screen -->
        <div class="login-container" id="loginScreen">
            <div class="logo">
                <h1>üè¢ Kurumsal Sistem</h1>
                <p>Onay ve ƒ∞≈ülem Y√∂netim Platformu</p>
            </div>
            <form onsubmit="login(event)">
                <div class="form-group">
                    <label>E-posta</label>
                    <input type="email" id="loginEmail" placeholder="ornek@mobilfon.com" required>
                </div>
                <div class="form-group">
                    <label>≈ûifre</label>
                    <input type="password" id="loginPassword" placeholder="≈ûifrenizi girin" required>
                </div>
                <button type="submit">
                    <span id="loginBtnText">Giri≈ü Yap</span>
                </button>
            </form>
            <div id="loginError" class="alert alert-error hidden" style="margin-top: 20px;"></div>
        </div>

        <!-- Dashboard -->
        <div id="dashboard" class="hidden">
            <nav class="navbar">
                <div class="navbar-left">
                    <div class="navbar-brand">üè¢ Kurumsal Sistem</div>
                    <div class="search-box">
                        <span class="search-icon">üîç</span>
                        <input type="text" id="searchInput" placeholder="Ara..." oninput="searchRecords()">
                    </div>
                </div>
                <div class="navbar-right">
                    <div class="user-info">
                        <span id="userEmail"></span>
                        <span id="userRole"></span>
                    </div>
                    <button class="logout-btn" onclick="logout()">√áƒ±kƒ±≈ü</button>
                </div>
            </nav>

            <div class="dashboard">
                <!-- Admin Dashboard -->
                <div id="adminDashboard" class="hidden">
                    <div class="grid">
                        <div class="stat-card">
                            <div class="stat-number" id="totalInvoices">0</div>
                            <div class="stat-label">Toplam Fatura</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="totalTransactions">0</div>
                            <div class="stat-label">Toplam ƒ∞≈ülem</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="pendingApprovals">0</div>
                            <div class="stat-label">Bekleyen Onay</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="completedToday">0</div>
                            <div class="stat-label">Bug√ºn Tamamlanan</div>
                        </div>
                    </div>

                    <div class="tabs">
                        <button class="tab active" onclick="switchTab('adminInvoices')">Faturalar</button>
                        <button class="tab" onclick="switchTab('adminTransactions')">ƒ∞≈ülemler</button>
                        <button class="tab" onclick="switchTab('adminCostPending')">Maliyet √ñdenecekler</button>
                        <button class="tab" onclick="switchTab('adminCostPaid')">Maliyet √ñdenenler</button>
                        <button class="tab" onclick="switchTab('adminLogs')">Sistem Loglarƒ±</button>
                        <button class="tab" onclick="switchTab('adminUsers')">Kullanƒ±cƒ± Y√∂netimi</button>
                        <button class="tab" onclick="switchTab('adminSettings')">Ayarlar</button>
                    </div>

                    <div id="adminInvoices" class="tab-content active">
                        <div class="card">
                            <div class="card-header">
                                <h2 class="card-title">T√ºm Faturalar</h2>
                            </div>
                            <div class="table-container">
                                <table id="adminInvoicesTable">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Fatura No</th>
                                            <th>Fatura Tarihi</th>
                                            <th>Tutar</th>
                                            <th>Firma</th>
                                            <th>Not</th>
                                            <th>Vade</th>
                                            <th>Olu≈üturan</th>
                                            <th>Durum</th>
                                            <th>ƒ∞≈ülemler</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div id="adminTransactions" class="tab-content">
                        <div class="card">
                            <div class="card-header">
                                <h2 class="card-title">T√ºm ƒ∞≈ülemler</h2>
                            </div>
                            <div class="table-container">
                                <table id="adminTransactionsTable">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Ad Soyad</th>
                                            <th>IMEI</th>
                                            <th>TC No</th>
                                            <th>Marka Model</th>
                                            <th>Servis T√ºr√º</th>
                                            <th>Tutar</th>
                                            <th>√ñdeme</th>
                                            <th>√ñdeme Tarihi</th>
                                            <th>Not/Maliyet</th>
                                            <th>Olu≈üturan</th>
                                            <th>Durum</th>
                                            <th>ƒ∞≈ülemler</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div id="adminCostPending" class="tab-content">
                        <div class="card">
                            <div class="card-header">
                                <h2 class="card-title">Maliyet √ñdenmeyi Bekleyenler</h2>
                            </div>
                            <div class="table-container">
                                <table id="adminCostPendingTable">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Ad Soyad</th>
                                            <th>IMEI</th>
                                            <th>TC No</th>
                                            <th>Marka Model</th>
                                            <th>Servis T√ºr√º</th>
                                            <th>Tutar</th>
                                            <th>Not/Maliyet</th>
                                            <th>Durum</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div id="adminCostPaid" class="tab-content">
                        <div class="card">
                            <div class="card-header">
                                <h2 class="card-title">Maliyet √ñdenenler</h2>
                            </div>
                            <div class="table-container">
                                <table id="adminCostPaidTable">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Ad Soyad</th>
                                            <th>IMEI</th>
                                            <th>TC No</th>
                                            <th>Marka Model</th>
                                            <th>Servis T√ºr√º</th>
                                            <th>Tutar</th>
                                            <th>Not/Maliyet</th>
                                            <th>Durum</th>
                                            <th>3. Onay Tarihi</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div id="adminLogs" class="tab-content">
                        <div class="card">
                            <div class="card-header">
                                <h2 class="card-title">Sistem Loglarƒ±</h2>
                            </div>
                            <div class="table-container">
                                <table id="adminLogsTable">
                                    <thead>
                                        <tr>
                                            <th>Tarih/Saat</th>
                                            <th>Kullanƒ±cƒ±</th>
                                            <th>ƒ∞≈ülem</th>
                                            <th>Detay</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div id="adminUsers" class="tab-content">
                        <div class="card">
                            <div class="card-header">
                                <h2 class="card-title">Yeni Kullanƒ±cƒ± Ekle</h2>
                            </div>
                            <form onsubmit="createUser(event)">
                                <div class="row">
                                    <div class="col">
                                        <div class="form-group">
                                            <label>E-posta *</label>
                                            <input type="email" id="newUserEmail" required placeholder="kullanici@mobilfon.com">
                                        </div>
                                    </div>
                                    <div class="col">
                                        <div class="form-group">
                                            <label>≈ûifre *</label>
                                            <input type="password" id="newUserPassword" required placeholder="En az 6 karakter">
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>Kullanƒ±cƒ± Rol√º *</label>
                                    <select id="newUserRole" required>
                                        <option value="">Se√ßiniz</option>
                                        <option value="admin">Admin (T√ºm Yetkilere Sahip)</option>
                                        <option value="selcuk">Fatura Olu≈üturma Yetkisi (Sel√ßuk gibi)</option>
                                        <option value="mehmet">ƒ∞≈ülem ve Fatura Olu≈üturma Yetkisi (Mehmet gibi)</option>
                                        <option value="ibrahim">1. Onay Yetkisi (ƒ∞brahim gibi)</option>
                                        <option value="mahmut">2. ve 3. Onay Yetkisi - Muhasebe (Mahmut gibi)</option>
                                       <option value="viewer">G√∂r√ºnt√ºleyici (Samil)</option>
                                        <option value="viewer">Sadece G√∂r√ºnt√ºleyici (Salt Okunur)</option>
                                    </select>
                                </div>
                                <button type="submit" class="btn btn-primary">Kullanƒ±cƒ± Olu≈ütur</button>
                            </form>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h2 class="card-title">Kayƒ±tlƒ± Kullanƒ±cƒ±lar</h2>
                            </div>
                            <div class="table-container">
                                <table id="usersTable">
                                    <thead>
                                        <tr>
                                            <th>E-posta</th>
                                            <th>Rol</th>
                                            <th>Olu≈üturulma Tarihi</th>
                                            <th>ƒ∞≈ülemler</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div id="adminSettings" class="tab-content">
                        <div class="card">
                            <div class="card-header">
                                <h2 class="card-title">Durum Se√ßenekleri</h2>
                            </div>
                            <div id="statusOptions"></div>
                            <button class="btn btn-primary" onclick="addStatusOption()">Yeni Durum Ekle</button>
                        </div>
                        <div class="card">
                            <div class="card-header">
                                <h2 class="card-title">Servis T√ºrleri</h2>
                            </div>
                            <div id="serviceTypeOptions"></div>
                            <button class="btn btn-primary" onclick="addServiceType()">Yeni Servis T√ºr√º Ekle</button>
                        </div>
                    </div>
                </div>



                <div id="viewerDashboard" class="hidden">
    <div class="grid">
        <div class="stat-card">
            <div class="stat-number" id="viewerTotalInvoices">0</div>
            <div class="stat-label">Toplam Fatura</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="viewerTotalTransactions">0</div>
            <div class="stat-label">Toplam ƒ∞≈ülem</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="viewerPendingApprovals">0</div>
            <div class="stat-label">Bekleyen Onay</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="viewerCompletedToday">0</div>
            <div class="stat-label">Bug√ºn Tamamlanan</div>
        </div>
    </div>

    <div class="tabs">
        <button class="tab active" onclick="switchTab('viewerInvoices')">T√ºm Faturalar</button>
        <button class="tab" onclick="switchTab('viewerTransactions')">T√ºm ƒ∞≈ülemler</button>
        <button class="tab" onclick="switchTab('viewerCostPending')">Maliyet Bekleyenler</button>
        <button class="tab" onclick="switchTab('viewerCostPaid')">Maliyet √ñdenenler</button>
    </div>

    <div id="viewerInvoices" class="tab-content active">
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">T√ºm Faturalar - Salt Okunur</h2>
            </div>
            <div class="info-box info-box-warning">
                <h4>üëÅÔ∏è Salt Okunur Eri≈üim</h4>
            </div>
            <div class="table-container">
                <table id="viewerInvoicesTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Fatura No</th>
                            <th>Fatura Tarihi</th>
                            <th>Tutar</th>
                            <th>Firma</th>
                            <th>Not</th>
                            <th>Vade</th> 
                            <th>Olu≈üturan</th>
                            <th>Durum</th>
                            <th>Son G√ºncelleme</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="viewerTransactions" class="tab-content">
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">T√ºm ƒ∞≈ülemler - Salt Okunur</h2>
            </div>
            <div class="table-container">
                <table id="viewerTransactionsTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Ad Soyad</th>
                            <th>IMEI</th>
                            <th>TC No</th>
                            <th>Marka Model</th>
                            <th>Servis T√ºr√º</th>
                            <th>Tutar</th>
                            <th>√ñdeme</th>
                            <th>√ñdeme Tarihi</th>
                            <th>Not/Maliyet</th>
                            <th>Olu≈üturan</th>
                            <th>Durum</th>
                            <th>Son G√ºncelleme</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="viewerCostPending" class="tab-content">
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Maliyet √ñdenmeyi Bekleyenler - Salt Okunur</h2>
            </div>
            <div class="table-container">
                <table id="viewerCostPendingTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Ad Soyad</th>
                            <th>IMEI</th>
                            <th>TC No</th>
                            <th>Marka Model</th>
                            <th>Servis T√ºr√º</th>
                            <th>Tutar</th>
                            <th>Not/Maliyet</th>
                            <th>Durum</th>
                            <th>2. Onay Tarihi</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="viewerCostPaid" class="tab-content">
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Maliyet √ñdenenler - Salt Okunur</h2>
            </div>
            <div class="table-container">
                <table id="viewerCostPaidTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Ad Soyad</th>
                            <th>IMEI</th>
                            <th>TC No</th>
                            <th>Marka Model</th>
                            <th>Servis T√ºr√º</th>
                            <th>Tutar</th>
                            <th>Not/Maliyet</th>
                            <th>Durum</th>
                            <th>3. Onay Tarihi</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

                <!-- Sel√ßuk Dashboard -->
           <div id="selcukDashboard" class="hidden">
                    <div class="tabs">
                        <button class="tab active" onclick="switchTab('createInvoice')">Fatura Olu≈ütur</button>
                        <button class="tab" onclick="switchTab('myInvoices')">Faturalarƒ±m</button>
                    </div>

                    <div id="createInvoice" class="tab-content active">
                        <div class="card">
                            <div class="card-header">
                                <h2 class="card-title">Yeni Fatura Olu≈ütur</h2>
                            </div>
                            <div class="info-box">
                                <h4>üìã Fatura Onay Akƒ±≈üƒ±</h4>
                                <p>Olu≈üturduƒüunuz faturalar ≈üu adƒ±mlardan ge√ßecektir:</p>
                                <p><strong>1. Adƒ±m:</strong> ƒ∞brahim (1. Onay)<br>
                                <strong>2. Adƒ±m:</strong> Muhasebe - Mahmut (2. Onay)</p>
                            </div>
                            <form onsubmit="createInvoice(event)">
                                <div class="row">
                                    <div class="col">
                                        <div class="form-group">
                                            <label>Fatura Numarasƒ± *</label>
                                            <input type="text" id="invoiceNumber" required>
                                        </div>
                                    </div>
                                    <div class="col">
                                        <div class="form-group">
                                            <label>Fatura Tarihi *</label>
                                            <input type="date" id="invoiceDate" required>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col">
                                        <div class="form-group">
                                            <label>Tutar (‚Ç∫) *</label>
                                            <input type="number" step="0.01" id="invoiceAmount" required>
                                        </div>
                                    </div>
                                    <div class="col">
                                        <div class="form-group">
                                            <label>Firma Bilgisi *</label>
                                            <input type="text" id="companyInfo" required>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>Vade Tarihi (ƒ∞steƒüe Baƒülƒ±)</label>
                                    <input type="text" id="invoiceDueDate" placeholder="√ñrn: 10 g√ºn, 15 g√ºn, 30 g√ºn">
                                </div>
                                <div class="form-group">
                                    <label>Not</label>
                                    <textarea id="invoiceNote"></textarea>
                                </div>
                                <button type="submit" class="btn btn-primary">Fatura Olu≈ütur</button>
                            </form>
                        </div>
                    </div>
                    

                    <div id="myInvoices" class="tab-content">
                        <div class="card">
                            <div class="card-header">
                                <h2 class="card-title">Olu≈üturduƒüum Faturalar</h2>
                            </div>
                            <div class="table-container">
                                <table id="selcukInvoicesTable">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Fatura No</th>
                                            <th>Fatura Tarihi</th>
                                            <th>Tutar</th>
                                            <th>Firma</th>
                                            <th>Not</th>
                                             <th>Vade</th> 
                                            <th>Durum</th>
                                            <th>ƒ∞≈ülemler</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Mehmet Dashboard - G√ºncellenmi≈ü -->
                <div id="mehmetDashboard" class="hidden">
                    <div class="tabs">
                        <button class="tab active" onclick="switchTab('createTransaction')">ƒ∞≈ülem Olu≈ütur</button>
                        <button class="tab" onclick="switchTab('myTransactions')">ƒ∞≈ülemlerim</button>
                        <button class="tab" onclick="switchTab('mehmetCreateInvoice')">Fatura Olu≈ütur</button>
                        <button class="tab" onclick="switchTab('mehmetMyInvoices')">Faturalarƒ±m</button>
                    </div>

                    <div id="createTransaction" class="tab-content active">
                        <div class="card">
                            <div class="card-header">
                                <h2 class="card-title">Yeni ƒ∞≈ülem Olu≈ütur</h2>
                            </div>
                            <form onsubmit="createTransaction(event)">
                                <div class="row">
                                    <div class="col">
                                        <div class="form-group">
                                            <label>Ad Soyad *</label>
                                            <input type="text" id="customerName" required>
                                        </div>
                                    </div>
                                    <div class="col">
                                        <div class="form-group">
                                            <label>IMEI Numarasƒ± *</label>
                                            <input type="text" id="imeiNumber" required>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col">
                                        <div class="form-group">
                                            <label>TC No (ƒ∞steƒüe Baƒülƒ±)</label>
                                            <input type="text" id="tcNumber" placeholder="TC Kimlik No">
                                        </div>
                                    </div>
                                    <div class="col">
                                        <div class="form-group">
                                            <label>Marka Model *</label>
                                            <input type="text" id="brandModel" required>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col">
                                        <div class="form-group">
                                            <label>Tutar (‚Ç∫) *</label>
                                            <input type="number" step="0.01" id="transAmount" required>
                                        </div>
                                    </div>
                                    <div class="col">
                                        <div class="form-group">
                                            <label>Servis T√ºr√º *</label>
                                            <div class="editable-select">
                                                <input type="text" id="serviceType" required onclick="toggleServiceTypes()" placeholder="Servis t√ºr√º se√ßin">
                                                <div id="serviceTypeDropdown" class="editable-options"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col">
                                        <div class="form-group">
                                            <label>√ñdeme Y√∂ntemi *</label>
                                            <select id="paymentMethod" required>
                                                <option value="">Se√ßiniz</option>
                                                <option value="Nakit">Nakit</option>
                                                <option value="Kredi Kartƒ±">Kredi Kartƒ±</option>
                                                <option value="Banka Transferi">Banka Transferi</option>
                                                <option value="Havale">Havale</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col">
                                        <div class="form-group">
                                            <label>√ñdeme Alƒ±nma Tarihi (ƒ∞steƒüe Baƒülƒ±)</label>
                                            <input type="date" id="paymentDate">
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>Not / Maliyet Bilgisi * (Zorunlu)</label>
                                    <textarea id="transNote" required placeholder="Maliyet bilgisini buraya girin..."></textarea>
                                    <small style="color: #ef4444; display: block; margin-top: 5px;">‚ö†Ô∏è Bu alan zorunludur. L√ºtfen maliyet bilgisini girin.</small>
                                </div>
                                <button type="submit" class="btn btn-primary">ƒ∞≈ülem Olu≈ütur</button>
                            </form>
                        </div>
                    </div>

                    <div id="myTransactions" class="tab-content">
                        <div class="card">
                            <div class="card-header">
                                <h2 class="card-title">Olu≈üturduƒüum ƒ∞≈ülemler</h2>
                            </div>
                            <div class="info-box">
                                <h4>‚úèÔ∏è D√ºzenleme Yetkisi</h4>
                                <p>ƒ∞brahim tarafƒ±ndan hen√ºz onaylanmamƒ±≈ü i≈ülemlerinizi d√ºzenleyebilirsiniz. ƒ∞brahim onay verdikten sonra d√ºzenleme yapƒ±lamaz.</p>
                            </div>
                            <div class="table-container">
                                <table id="mehmetTransactionsTable">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Ad Soyad</th>
                                            <th>IMEI</th>
                                            <th>TC No</th>
                                            <th>Marka Model</th>
                                            <th>Servis T√ºr√º</th>
                                            <th>Tutar</th>
                                            <th>√ñdeme</th>
                                            <th>√ñdeme Tarihi</th>
                                            <th>Not/Maliyet</th>
                                            <th>Durum</th>
                                            <th>ƒ∞≈ülemler</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                 <div id="mehmetCreateInvoice" class="tab-content">
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Yeni Fatura Olu≈ütur</h2>
        </div>
        <div class="info-box">
            <h4>üìã Fatura Onay Akƒ±≈üƒ±</h4>
            <p>Olu≈üturduƒüunuz faturalar ≈üu adƒ±mlardan ge√ßecektir:</p>
            <p><strong>1. Adƒ±m:</strong> ƒ∞brahim (1. Onay)<br>
            <strong>2. Adƒ±m:</strong> Muhasebe - Mahmut (2. Onay)<br>
            <strong>Sonu√ß:</strong> Onaylanan faturalar otomatik olarak "Onaylananlar" listesine eklenir.</p>
            <p style="margin-top: 10px; color: #10b981;"><strong>‚úèÔ∏è Not:</strong> ƒ∞brahim onaylamadan √∂nce faturalarƒ±nƒ±zƒ± d√ºzenleyebilirsiniz.</p>
        </div>
        <div class="info-box info-box-success">
            <h4>üîó ƒ∞≈ülem-Fatura E≈üle≈ütirme</h4>
            <p><strong>ƒ∞steƒüe Baƒülƒ± √ñzellik:</strong> Eƒüer bu faturayƒ± daha √∂nce olu≈üturduƒüunuz bir i≈ülemle ili≈ükilendirmek istiyorsanƒ±z:</p>
            <p>‚Ä¢ <strong>NOT alanƒ±na i≈ülem ID'sini</strong> (√∂rn: 123456) yazƒ±n<br>
            ‚Ä¢ Sistem otomatik olarak o i≈ülemi bulup faturayƒ± aynƒ± ID ile olu≈üturacak<br>
            ‚Ä¢ ƒ∞≈ülem-Fatura baƒülantƒ±sƒ± otomatik kurulacak</p>
            <p style="margin-top: 10px; color: #16a34a;"><strong>‚úì Avantajlar:</strong></p>
            <p>‚Ä¢ Tek ID ile i≈ülem ve faturayƒ± takip edin<br>
            ‚Ä¢ Muhasebe ve onay s√ºre√ßlerinde kolayca e≈üle≈ütirin<br>
            ‚Ä¢ Manuel e≈üle≈ütirme hatalarƒ±nƒ± √∂nleyin</p>
        </div>
        <form onsubmit="createInvoiceMehmet(event)">
            <div class="row">
                <div class="col">
                    <div class="form-group">
                        <label>Fatura Numarasƒ± *</label>
                        <input type="text" id="mehmetInvoiceNumber" required>
                    </div>
                </div>
                <div class="col">
                    <div class="form-group">
                        <label>Fatura Tarihi *</label>
                        <input type="date" id="mehmetInvoiceDate" required>
                    </div>
                </div>
                <div class="col"> <!-- Bu div kapanƒ±≈üƒ± eksikti -->
                    <div class="form-group">
                        <label>Vade Tarihi (ƒ∞steƒüe Baƒülƒ±)</label>
                        <input type="text" id="mehmetInvoiceDueDate" placeholder="√ñrn: 10 g√ºn, 15 g√ºn, 30 g√ºn">
                    </div>
                </div>
            </div> <!-- Bu kapanƒ±≈ü etiketi eksikti -->
            <div class="row">
                <div class="col">
                    <div class="form-group">
                        <label>Tutar (‚Ç∫) *</label>
                        <input type="number" step="0.01" id="mehmetInvoiceAmount" required>
                    </div>
                </div>
                <div class="col">
                    <div class="form-group">
                        <label>Firma Bilgisi *</label>
                        <input type="text" id="mehmetCompanyInfo" required>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label>Not (ƒ∞≈ülem ID'si i√ßin - ƒ∞steƒüe Baƒülƒ±) üîó</label>
                <textarea id="mehmetInvoiceNote" placeholder="Bu faturayƒ± bir i≈ülemle ili≈ükilendirmek i√ßin i≈ülem ID'sini buraya yazƒ±n (√∂rn: 123456). Bo≈ü bƒ±rakƒ±rsanƒ±z otomatik ID olu≈üturulur."></textarea>
                <small style="color: #16a34a; display: block; margin-top: 5px;">
                    üí° ƒ∞pucu: ƒ∞≈ülemlerim sekmesinden ID numarasƒ±nƒ± kopyalayabilirsiniz.
                </small>
            </div>
            <button type="submit" class="btn btn-primary">Fatura Olu≈ütur</button>
        </form>
    </div>
</div>

                    <div id="mehmetMyInvoices" class="tab-content">
                        <div class="card">
                            <div class="card-header">
                                <h2 class="card-title">Olu≈üturduƒüum Faturalar</h2>
                            </div>
                            <div class="info-box">
                                <h4>‚úèÔ∏è D√ºzenleme Yetkisi</h4>
                                <p>ƒ∞brahim tarafƒ±ndan hen√ºz onaylanmamƒ±≈ü faturalarƒ±nƒ±zƒ± d√ºzenleyebilirsiniz. ƒ∞brahim onay verdikten sonra d√ºzenleme yapƒ±lamaz.</p>
                            </div>
                            <div class="table-container">
                                <table id="mehmetInvoicesTable">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Fatura No</th>
                                            <th>Fatura Tarihi</th>
                                            <th>Tutar</th>
                                            <th>Firma</th>
                                            <th>Not</th>
                                             <th>Vade</th>
                                            <th>Durum</th>
                                            <th>ƒ∞≈ülemler</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ƒ∞brahim Dashboard -->
                <div id="ibrahimDashboard" class="hidden">
                    <div class="grid">
                        <div class="stat-card">
                            <div class="stat-number" id="ibrahimPending">0</div>
                            <div class="stat-label">Bekleyen ƒ∞≈ülem Onayƒ±</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="ibrahimApproved">0</div>
                            <div class="stat-label">Onaylanan ƒ∞≈ülem</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="ibrahimPendingInvoices">0</div>
                            <div class="stat-label">Bekleyen Fatura</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="ibrahimApprovedInvoices">0</div>
                            <div class="stat-label">Onaylanan Fatura</div>
                        </div>
                    </div>

                    <div class="tabs">
                        <button class="tab active" onclick="switchTab('ibrahimPendingTab')">Bekleyen ƒ∞≈ülemler</button>
                        <button class="tab" onclick="switchTab('ibrahimApprovedTab')">Onaylanan ƒ∞≈ülemler</button>
                        <button class="tab" onclick="switchTab('ibrahimInvoicesPendingTab')">Bekleyen Faturalar</button>
                        <button class="tab" onclick="switchTab('ibrahimInvoicesApprovedTab')">Onaylanan Faturalar</button>
                    </div>

                    <div id="ibrahimPendingTab" class="tab-content active">
                        <div class="card">
                            <div class="card-header">
                                <h2 class="card-title">1. Onay Bekleyen ƒ∞≈ülemler</h2>
                            </div>
                            <div class="table-container">
                                <table id="ibrahimPendingTable">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Ad Soyad</th>
                                            <th>IMEI</th>
                                            <th>TC No</th>
                                            <th>Marka Model</th>
                                            <th>Servis T√ºr√º</th>
                                            <th>Tutar</th>
                                            <th>√ñdeme</th>
                                            <th>√ñdeme Tarihi</th>
                                            <th>Not/Maliyet</th>
                                            <th>Durum</th>
                                            <th>ƒ∞≈ülemler</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div id="ibrahimApprovedTab" class="tab-content">
                        <div class="card">
                            <div class="card-header">
                                <h2 class="card-title">Onayladƒ±ƒüƒ±m ƒ∞≈ülemler</h2>
                            </div>
                            <div class="table-container">
                                <table id="ibrahimApprovedTable">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Ad Soyad</th>
                                            <th>IMEI</th>
                                            <th>TC No</th>
                                            <th>Marka Model</th>
                                            <th>Servis T√ºr√º</th>
                                            <th>Tutar</th>
                                            <th>√ñdeme</th>
                                            <th>√ñdeme Tarihi</th>
                                            <th>Not/Maliyet</th>
                                            <th>Durum</th>
                                            <th>ƒ∞≈ülemler</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div id="ibrahimInvoicesPendingTab" class="tab-content">
                        <div class="card">
                            <div class="card-header">
                                <h2 class="card-title">1. Onay Bekleyen Faturalar</h2>
                            </div>
                             <div class="table-container">
            <table id="ibrahimInvoicesPendingTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Fatura No</th>
                        <th>Fatura Tarihi</th>
                        <th>Tutar</th>
                        <th>Firma</th>
                        <th>Not</th>
                        <th>Vade</th>
                        <th>Olu≈üturan</th>
                        <th>Durum</th>
                        <th>ƒ∞≈ülemler</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>
                    </div>
<div id="ibrahimInvoicesApprovedTab" class="tab-content">
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">1. Onayƒ± Verdiƒüim Faturalar</h2>
        </div>
        <div class="table-container">
            <table id="ibrahimInvoicesApprovedTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Fatura No</th>
                        <th>Fatura Tarihi</th>
                        <th>Tutar</th>
                        <th>Firma</th>
                        <th>Not</th>
                        <th>Vade</th>
                        <th>Olu≈üturan</th>
                        <th>Durum</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

                <!-- Muhasebe Dashboard (Mahmut) -->
                <div id="mahmutDashboard" class="hidden">
                    <div class="grid">
                        <div class="stat-card">
                            <div class="stat-number" id="mahmutPendingInvoices">0</div>
                            <div class="stat-label">Bekleyen Fatura (2. Onay)</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="mahmutPendingTransactions">0</div>
                            <div class="stat-label">Bekleyen ƒ∞≈ülem (2. Onay)</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="mahmutCostPending">0</div>
                            <div class="stat-label">Maliyet Onayƒ± Bekleyen</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="mahmutCostPaid">0</div>
                            <div class="stat-label">Maliyet √ñdenenler</div>
                        </div>
                    </div>

                    <div class="tabs">
                        <button class="tab active" onclick="switchTab('invoiceApprovals')">Fatura Onaylarƒ± (2)</button>
                        <button class="tab" onclick="switchTab('transactionApprovals')">M√º≈üteri Kayƒ±tlarƒ± (2)</button>
                        <button class="tab" onclick="switchTab('costApprovals')">Maliyet Onaylarƒ± (3)</button>
                        <button class="tab" onclick="switchTab('approvedInvoices')">Onaylanan Faturalar</button>
                        <button class="tab" onclick="switchTab('costPaidList')">Maliyet √ñdenenler</button>
                    </div>

                    <div id="invoiceApprovals" class="tab-content active">
                        <div class="card">
                            <div class="card-header">
                                <h2 class="card-title">Fatura Onay Listesi (2. Onay)</h2>
                            </div>
                            <div class="table-container">
                                <table id="mahmutInvoicesPendingTable">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Fatura No</th>
                                            <th>Fatura Tarihi</th>
                                            <th>Tutar</th>
                                            <th>Firma</th>
                                            <th>Not</th>
                                            <th>Vade</th> 
                                            <th>Olu≈üturan</th>
                                            <th>Durum</th>
                                            <th>ƒ∞≈ülemler</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div id="transactionApprovals" class="tab-content">
                        <div class="card">
                            <div class="card-header">
                                <h2 class="card-title">ƒ∞≈ülem Onay Listesi (2. Onay)</h2>
                            </div>
                            <div class="table-container">
                                <table id="mahmutTransactionsPendingTable">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Ad Soyad</th>
                                            <th>IMEI</th>
                                            <th>TC No</th>
                                            <th>Marka Model</th>
                                            <th>Servis T√ºr√º</th>
                                            <th>Tutar</th>
                                            <th>√ñdeme</th>
                                            <th>√ñdeme Tarihi</th>
                                            <th>Not/Maliyet</th>
                                            <th>Durum</th>
                                            <th>ƒ∞≈ülemler</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div id="costApprovals" class="tab-content">
                        <div class="card">
                            <div class="card-header">
                                <h2 class="card-title">Maliyet Onay Listesi (3. Onay)</h2>
                                <p style="color: #6b7280; font-size: 14px;">Birinci ve ikinci onayƒ± tamamlamƒ±≈ü i≈ülemler</p>
                            </div>
                            <div class="table-container">
                                <table id="mahmutCostPendingTable">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Ad Soyad</th>
                                            <th>IMEI</th>
                                            <th>TC No</th>
                                            <th>Marka Model</th>
                                            <th>Servis T√ºr√º</th>
                                            <th>Tutar</th>
                                            <th>Not/Maliyet</th>
                                            <th>Durum</th>
                                            <th>ƒ∞≈ülemler</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div id="approvedInvoices" class="tab-content">
                        <div class="card">
                            <div class="card-header">
                                <h2 class="card-title">2. Onayƒ± Verdiƒüim Faturalar</h2>
                            </div>
                            <div class="table-container">
                                <table id="mahmutInvoicesApprovedTable">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Fatura No</th>
                                            <th>Fatura Tarihi</th>
                                            <th>Tutar</th>
                                            <th>Firma</th>
                                            <th>Not</th>
                                            <th>Vade</th>
                                            <th>Olu≈üturan</th>
                                            <th>Durum</th>
                                            <th>ƒ∞≈ülemler</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div id="approvedTransactions" class="tab-content">
                        <div class="card">
                            <div class="card-header">
                                <h2 class="card-title">2. Onayƒ± Verdiƒüim ƒ∞≈ülemler</h2>
                            </div>
                            <div class="table-container">
                                <table id="mahmutTransactionsApprovedTable">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Ad Soyad</th>
                                            <th>IMEI</th>
                                            <th>TC No</th>
                                            <th>Marka Model</th>
                                            <th>Servis T√ºr√º</th>
                                            <th>Tutar</th>
                                            <th>√ñdeme</th>
                                            <th>√ñdeme Tarihi</th>
                                            <th>Not/Maliyet</th>
                                            <th>Durum</th>
                                            <th>ƒ∞≈ülemler</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div id="costPaidList" class="tab-content">
                        <div class="card">
                            <div class="card-header">
                                <h2 class="card-title">Maliyet √ñdenenler (3. Onay Tamamlananlar)</h2>
                            </div>
                            <div class="table-container">
                                <table id="mahmutCostPaidTable">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Ad Soyad</th>
                                            <th>IMEI</th>
                                            <th>TC No</th>
                                            <th>Marka Model</th>
                                            <th>Servis T√ºr√º</th>
                                            <th>Tutar</th>
                                            <th>Not/Maliyet</th>
                                            <th>Durum</th>
                                            <th>3. Onay Tarihi</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <div class="modal-header" id="modalTitle">Onay Gerekli</div>
            <div class="modal-body" id="modalMessage">Bu i≈ülemi yapmak istediƒüinizden emin misiniz?</div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="closeModal()">ƒ∞ptal</button>
                <button class="btn btn-success" id="modalConfirmBtn">Onayla</button>
            </div>
        </div>
    </div>

    <!-- Edit Modal for Transactions -->
    <div id="editTransactionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">ƒ∞≈ülem D√ºzenle</div>
            <div class="modal-body">
                <form id="editTransactionForm">
                    <input type="hidden" id="editTransactionId">
                    <div class="row">
                        <div class="col">
                            <div class="form-group">
                                <label>Ad Soyad *</label>
                                <input type="text" id="editCustomerName" required>
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-group">
                                <label>IMEI Numarasƒ± *</label>
                                <input type="text" id="editImeiNumber" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">
                            <div class="form-group">
                                <label>TC No</label>
                                <input type="text" id="editTcNumber">
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-group">
                                <label>Marka Model *</label>
                                <input type="text" id="editBrandModel" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">
                            <div class="form-group">
                                <label>Tutar (‚Ç∫) *</label>
                                <input type="number" step="0.01" id="editTransAmount" required>
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-group">
                                <label>Servis T√ºr√º *</label>
                                <input type="text" id="editServiceType" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">
                            <div class="form-group">
                                <label>√ñdeme Y√∂ntemi *</label>
                                <select id="editPaymentMethod" required>
                                    <option value="">Se√ßiniz</option>
                                    <option value="Nakit">Nakit</option>
                                    <option value="Kredi Kartƒ±">Kredi Kartƒ±</option>
                                    <option value="Banka Transferi">Banka Transferi</option>
                                    <option value="Havale">Havale</option>
                                </select>
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-group">
                                <label>√ñdeme Tarihi</label>
                                <input type="date" id="editPaymentDate">
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Not / Maliyet Bilgisi *</label>
                        <textarea id="editTransNote" required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="closeEditTransactionModal()">ƒ∞ptal</button>
                <button class="btn btn-success" onclick="saveTransactionEdit()">Kaydet</button>
            </div>
        </div>
    </div>

    <!-- Edit Modal for Invoices -->
    <div id="editInvoiceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Fatura D√ºzenle</div>
            <div class="modal-body">
                <form id="editInvoiceForm">
                    <input type="hidden" id="editInvoiceId">
                    <div class="row">
                        <div class="col">
                            <div class="form-group">
                                <label>Fatura Numarasƒ± *</label>
                                <input type="text" id="editInvoiceNumber" required>
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-group">
                                <label>Fatura Tarihi *</label>
                                <input type="date" id="editInvoiceDate" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">
                            <div class="form-group">
                                <label>Tutar (‚Ç∫) *</label>
                                <input type="number" step="0.01" id="editInvoiceAmount" required>
                            </div>
                        </div>
                        <div class="col">
                            <div class="form-group">
                                <label>Firma Bilgisi *</label>
                                <input type="text" id="editCompanyInfo" required>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Not</label>
                        <textarea id="editInvoiceNote"></textarea>
                    </div>
                     <div class="form-group"> <!-- YENƒ∞ EKLENEN: Vade tarihi alanƒ± -->
                    <label>Vade Tarihi</label>
                    <input type="text" id="editInvoiceDueDate" placeholder="√ñrn: 10 g√ºn, 15 g√ºn, 30 g√ºn">
                </div>
                
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="closeEditInvoiceModal()">ƒ∞ptal</button>
                <button class="btn btn-success" onclick="saveInvoiceEdit()">Kaydet</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getDatabase, ref, set, get, push, onValue, remove, update } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyAzmBBUlvuaIZNtrTdf8drMLqTCf3qlyLo",
            authDomain: "muhasebe-14b3d.firebaseapp.com",
            projectId: "muhasebe-14b3d",
            storageBucket: "muhasebe-14b3d.firebasestorage.app",
            messagingSenderId: "954504942890",
            appId: "1:954504942890:web:1cd51ff20419ed81987a53",
            databaseURL: "https://muhasebe-14b3d-default-rtdb.firebaseio.com"
        };

        // Mail G√∂nderme Yardƒ±mcƒ± Fonksiyonu
async function sendEmailNotification(toRole, subject, detailMsg) {
    // Rollerin ger√ßek mail adreslerini buraya tanƒ±mla
    const emails = {
        'ibrahim': 'ibrahim.duz@turnacioglu.com.tr', // Ger√ßek mail adresi olmalƒ±
        'mahmut': 'yunus.ozden@mobilfon.com'  // Ger√ßek mail adresi olmalƒ±
    };

    const targetEmail = emails[toRole];
    
    if (!targetEmail) {
        console.log('Bu rol i√ßin mail tanƒ±mlƒ± deƒüil:', toRole);
        return;
    }

    const templateParams = {
        to_email: targetEmail,
        subject: subject,
        message: detailMsg
    };

    // 'service_xxx' ve 'template_xxx' kƒ±sƒ±mlarƒ±nƒ± EmailJS'den aldƒ±klarƒ±nla deƒüi≈ütir
    try {
        await emailjs.send('service_ir6y58a', 'template_j1qjuy7', templateParams);
        console.log('Mail ba≈üarƒ±yla g√∂nderildi:', targetEmail);
    } catch (error) {
        console.error('Mail g√∂nderme hatasƒ±:', error);
    }
}

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        window.auth = auth;
        window.db = db;
        window.dbRef = ref;
        window.dbSet = set;
        window.dbGet = get;
        window.dbPush = push;
        window.dbOnValue = onValue;
        window.dbRemove = remove;
        window.dbUpdate = update;

        let currentUser = null;
        let currentUserRole = null;
        let pendingAction = null;

        const defaultUserRoles = {
            'admin@servis.com': 'admin',
            'selcuk@mobilfon.com': 'selcuk',
            'mehmet@mobilfon.com': 'mehmet',
            'muhasebe@mobilfon.com': 'mahmut',
            'ibrahim@mobilfon.com': 'ibrahim',
            'samil@mobilfon.com': 'viewer'
        };

        function generateSixDigitId() {
            return Math.floor(100000 + Math.random() * 900000).toString();
        }

        // Modal Functions
        window.showConfirmModal = function(title, message, onConfirm) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').textContent = message;
            document.getElementById('confirmModal').classList.add('active');
            
            pendingAction = onConfirm;
            
            document.getElementById('modalConfirmBtn').onclick = function() {
                if (pendingAction) {
                    pendingAction();
                    pendingAction = null;
                }
                closeModal();
            };
        };

        window.closeModal = function() {
            document.getElementById('confirmModal').classList.remove('active');
            pendingAction = null;
        };

        // Edit Transaction Modal Functions
        window.openEditTransactionModal = async function(transactionId) {
            const transactionRef = dbRef(db, `transactions/${transactionId}`);
            const snapshot = await dbGet(transactionRef);
            const transaction = snapshot.val();
            
            document.getElementById('editTransactionId').value = transactionId;
            document.getElementById('editCustomerName').value = transaction.customerName;
            document.getElementById('editImeiNumber').value = transaction.imeiNumber;
            document.getElementById('editTcNumber').value = transaction.tcNumber || '';
            document.getElementById('editBrandModel').value = transaction.brandModel;
            document.getElementById('editTransAmount').value = transaction.amount;
            document.getElementById('editServiceType').value = transaction.serviceType;
            document.getElementById('editPaymentMethod').value = transaction.paymentMethod;
            document.getElementById('editPaymentDate').value = transaction.paymentDate || '';
            document.getElementById('editTransNote').value = transaction.note || '';
            
            document.getElementById('editTransactionModal').classList.add('active');
        };

        window.closeEditTransactionModal = function() {
            document.getElementById('editTransactionModal').classList.remove('active');
            document.getElementById('editTransactionForm').reset();
        };

        window.saveTransactionEdit = async function() {
            const transactionId = document.getElementById('editTransactionId').value;
            const transactionRef = dbRef(db, `transactions/${transactionId}`);
            
            const updatedData = {
                customerName: document.getElementById('editCustomerName').value,
                imeiNumber: document.getElementById('editImeiNumber').value,
                tcNumber: document.getElementById('editTcNumber').value || '',
                brandModel: document.getElementById('editBrandModel').value,
                amount: parseFloat(document.getElementById('editTransAmount').value),
                serviceType: document.getElementById('editServiceType').value,
                paymentMethod: document.getElementById('editPaymentMethod').value,
                paymentDate: document.getElementById('editPaymentDate').value || '',
                note: document.getElementById('editTransNote').value,
                lastEditedBy: currentUser.email,
                lastEditedAt: new Date().toISOString()
            };
            
            await dbUpdate(transactionRef, updatedData);
            await addLog(currentUser.email, 'ƒ∞≈ülem D√ºzenledi', `ID: ${transactionId}`);
            
            alert('ƒ∞≈ülem ba≈üarƒ±yla g√ºncellendi!');
            closeEditTransactionModal();
            
            if (currentUserRole === 'mehmet') {
                loadMehmetData();
            } else if (currentUserRole === 'selcuk') {
                loadSelcukData();
            }
        };

        // Edit Invoice Modal Functions
        window.openEditInvoiceModal = async function(invoiceId) {
            const invoiceRef = dbRef(db, `invoices/${invoiceId}`);
            const snapshot = await dbGet(invoiceRef);
            const invoice = snapshot.val();
            
            document.getElementById('editInvoiceId').value = invoiceId;
            document.getElementById('editInvoiceNumber').value = invoice.invoiceNumber;
            document.getElementById('editInvoiceDate').value = invoice.invoiceDate;
            document.getElementById('editInvoiceAmount').value = invoice.amount;
            document.getElementById('editCompanyInfo').value = invoice.company;
            document.getElementById('editInvoiceNote').value = invoice.note || '';
            document.getElementById('editInvoiceDueDate').value = invoice.dueDate || ''; // YENƒ∞ EKLENEN: Vade tarihi
            
            document.getElementById('editInvoiceModal').classList.add('active');
        };

        window.closeEditInvoiceModal = function() {
            document.getElementById('editInvoiceModal').classList.remove('active');
            document.getElementById('editInvoiceForm').reset();
        };

        window.saveInvoiceEdit = async function() {
            const invoiceId = document.getElementById('editInvoiceId').value;
            const invoiceRef = dbRef(db, `invoices/${invoiceId}`);
            
            const updatedData = {
                invoiceNumber: document.getElementById('editInvoiceNumber').value,
                invoiceDate: document.getElementById('editInvoiceDate').value,
                amount: parseFloat(document.getElementById('editInvoiceAmount').value),
                company: document.getElementById('editCompanyInfo').value,
                note: document.getElementById('editInvoiceNote').value,
                
                lastEditedBy: currentUser.email,
                lastEditedAt: new Date().toISOString()
            };
            
            await dbUpdate(invoiceRef, updatedData);
            await addLog(currentUser.email, 'Fatura D√ºzenledi', `ID: ${invoiceId}`);
            
            alert('Fatura ba≈üarƒ±yla g√ºncellendi!');
            closeEditInvoiceModal();
            
            if (currentUserRole === 'mehmet') {
                loadMehmetData();
            } else if (currentUserRole === 'selcuk') {
                loadSelcukData();
            }
        };

        // Close modal when clicking outside
        window.onclick = function(event) {
            const confirmModal = document.getElementById('confirmModal');
            const editTransactionModal = document.getElementById('editTransactionModal');
            const editInvoiceModal = document.getElementById('editInvoiceModal');
            
            if (event.target === confirmModal) {
                closeModal();
            }
            if (event.target === editTransactionModal) {
                closeEditTransactionModal();
            }
            if (event.target === editInvoiceModal) {
                closeEditInvoiceModal();
            }
        };

        async function initializeDefaults() {
            const statusRef = dbRef(db, 'statusOptions');
            const serviceRef = dbRef(db, 'serviceTypes');
            
            const statusSnap = await dbGet(statusRef);
            if (!statusSnap.exists()) {
                await dbSet(statusRef, {
                    'option1': '1. Onay Bekliyor',
                    'option2': '2. Onay Bekliyor',
                    'option3': 'Maliyet Onayƒ± Bekliyor',
                    'option4': 'Onaylandƒ±',
                    'option5': 'Tamamlandƒ±',
                    'option6': 'Reddedildi'
                });
            }

            const serviceSnap = await dbGet(serviceRef);
            if (!serviceSnap.exists()) {
                await dbSet(serviceRef, {
                    'type1': 'Dƒ±≈ü Servis',
                    'type2': 'Anakart Dƒ±≈ü Servis',
                    'type3': '√ñn Cam Dƒ±≈ü Servis',
                    'type4': 'Ekran Deƒüi≈üimi',
                    'type5': 'Batarya Deƒüi≈üimi'
                });
            }

            const usersRef = dbRef(db, 'users');
            const usersSnap = await dbGet(usersRef);
            if (!usersSnap.exists()) {
                for (let email in defaultUserRoles) {
                    const userRef = dbRef(db, `users/${email.replace(/[@.]/g, '_')}`);
                    await dbSet(userRef, {
                        email: email,
                        role: defaultUserRoles[email],
                        createdAt: new Date().toISOString(),
                        createdBy: 'system'
                    });
                }
            }
        }

        async function getUserRole(email) {
            const usersRef = dbRef(db, 'users');
            const snapshot = await dbGet(usersRef);
            
            if (snapshot.exists()) {
                const users = snapshot.val();
                for (let uid in users) {
                    if (users[uid].email === email) {
                        return users[uid].role;
                    }
                }
            }
            
            return defaultUserRoles[email] || null;
        }

        window.login = async function(event) {
            event.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');
            const btnText = document.getElementById('loginBtnText');

            btnText.innerHTML = '<span class="loading"></span>';
            errorDiv.classList.add('hidden');

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                await addLog(email, 'Giri≈ü Yaptƒ±', 'Kullanƒ±cƒ± sisteme giri≈ü yaptƒ±');
            } catch (error) {
                btnText.textContent = 'Giri≈ü Yap';
                errorDiv.textContent = 'Giri≈ü ba≈üarƒ±sƒ±z! E-posta veya ≈üifre hatalƒ±.';
                errorDiv.classList.remove('hidden');
            }
        };

        window.createUser = async function(event) {
            event.preventDefault();
            
            const email = document.getElementById('newUserEmail').value;
            const password = document.getElementById('newUserPassword').value;
            const role = document.getElementById('newUserRole').value;

            if (password.length < 6) {
                alert('≈ûifre en az 6 karakter olmalƒ±dƒ±r!');
                return;
            }

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                const usersRef = dbRef(db, `users/${user.uid}`);
                await dbSet(usersRef, {
                    email: email,
                    role: role,
                    createdAt: new Date().toISOString(),
                    createdBy: currentUser.email
                });

                await addLog(currentUser.email, 'Yeni Kullanƒ±cƒ± Olu≈üturdu', `E-posta: ${email}, Rol: ${role}`);
                
                alert('Kullanƒ±cƒ± ba≈üarƒ±yla olu≈üturuldu!');
                event.target.reset();
                
                await signOut(auth);
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
                
            } catch (error) {
                console.error('Kullanƒ±cƒ± olu≈üturma hatasƒ±:', error);
                if (error.code === 'auth/email-already-in-use') {
                    alert('Bu e-posta adresi zaten kullanƒ±mda!');
                } else if (error.code === 'auth/weak-password') {
                    alert('≈ûifre √ßok zayƒ±f!');
                } else {
                    alert('Kullanƒ±cƒ± olu≈üturulurken bir hata olu≈ütu: ' + error.message);
                }
            }
        };

        function loadUsers() {
            const usersRef = dbRef(db, 'users');
            dbOnValue(usersRef, (snapshot) => {
                const users = [];
                snapshot.forEach((child) => {
                    users.push({ uid: child.key, ...child.val() });
                });
                
                const tbody = document.querySelector('#usersTable tbody');
                tbody.innerHTML = '';
                users.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)).forEach(user => {
                    tbody.innerHTML += `
                        <tr>
                            <td>${user.email}</td>
                            <td><span class="badge badge-user">${getRoleDisplayName(user.role)}</span></td>
                            <td>${new Date(user.createdAt).toLocaleString('tr-TR')}</td>
                            <td>
                                ${user.email !== 'admin@servis.com' && user.createdBy !== 'system' ? 
                                    `<button class="action-btn btn-danger" onclick="deleteUser('${user.uid}', '${user.email}')">Sil</button>` : 
                                    '<span class="badge badge-admin">Sistem Kullanƒ±cƒ±sƒ±</span>'
                                }
                            </td>
                        </tr>
                    `;
                });
            });
        }

        window.deleteUser = async function(uid, email) {
            showConfirmModal(
                'Kullanƒ±cƒ± Silme',
                `${email} kullanƒ±cƒ±sƒ±nƒ± silmek istediƒüinizden emin misiniz?`,
                async () => {
                    try {
                        const userRef = dbRef(db, `users/${uid}`);
                        await dbRemove(userRef);
                        await addLog(currentUser.email, 'Kullanƒ±cƒ± Sildi', `E-posta: ${email}`);
                        alert('Kullanƒ±cƒ± silindi!');
                    } catch (error) {
                        alert('Kullanƒ±cƒ± silinirken bir hata olu≈ütu: ' + error.message);
                    }
                }
            );
        };

        window.logout = async function() {
            await addLog(currentUser.email, '√áƒ±kƒ±≈ü Yaptƒ±', 'Kullanƒ±cƒ± sistemden √ßƒ±kƒ±≈ü yaptƒ±');
            await signOut(auth);
        };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                currentUserRole = await getUserRole(user.email);
                
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                document.getElementById('userEmail').textContent = user.email;
                document.getElementById('userRole').textContent = `(${getRoleDisplayName(currentUserRole)})`;
                showDashboard(currentUserRole);
                initializeDefaults();
            } else {
                currentUser = null;
                currentUserRole = null;
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('dashboard').classList.add('hidden');
                document.getElementById('loginBtnText').textContent = 'Giri≈ü Yap';
            }
        });

        function getRoleDisplayName(role) {
            const roleNames = {
                'admin': 'Genel Admin',
                'selcuk': 'Fatura Olu≈üturma',
                'mehmet': 'ƒ∞≈ülem ve Fatura Olu≈üturma',
                'mahmut': 'Muhasebe 2. ve 3. Onay',
                'ibrahim': '1. Onay',
                'viewer': 'Sadece G√∂r√ºnt√ºleyici'  // YENƒ∞ EKLENEN
            };
            return roleNames[role] || role;
        }

       function showDashboard(role) {
    ['adminDashboard', 'selcukDashboard', 'mehmetDashboard', 'mahmutDashboard', 'ibrahimDashboard', 'viewerDashboard'].forEach(id => {
        document.getElementById(id).classList.add('hidden');
    });

    switch(role) {
        case 'admin':
            document.getElementById('adminDashboard').classList.remove('hidden');
            loadAdminData();
            loadUsers();
            break;
        case 'selcuk':
            document.getElementById('selcukDashboard').classList.remove('hidden');
            loadSelcukData();
            break;
        case 'mehmet':
            document.getElementById('mehmetDashboard').classList.remove('hidden');
            loadMehmetData();
            loadStatusOptions();
            loadServiceTypes();
            break;
        case 'mahmut':
            document.getElementById('mahmutDashboard').classList.remove('hidden');
            loadMahmutData();
            break;
        case 'ibrahim':
            document.getElementById('ibrahimDashboard').classList.remove('hidden');
            loadIbrahimData();
            break;
        case 'viewer':  // YENƒ∞ EKLENEN
            document.getElementById('viewerDashboard').classList.remove('hidden');
            loadViewerData();
            break;
    }
}


        async function addLog(userId, action, details) {
            const logsRef = dbRef(db, 'logs');
            const newLogRef = dbPush(logsRef);
            await dbSet(newLogRef, {
                userId: userId,
                action: action,
                details: details,
                timestamp: new Date().toISOString()
            });
        }

        window.createInvoice = async function(event) {
            event.preventDefault();
            
            const sixDigitId = generateSixDigitId();
            
            const invoiceData = {
                customId: sixDigitId,
                invoiceNumber: document.getElementById('invoiceNumber').value,
                invoiceDate: document.getElementById('invoiceDate').value,
                amount: parseFloat(document.getElementById('invoiceAmount').value),
                company: document.getElementById('companyInfo').value,
                note: document.getElementById('invoiceNote').value,
                  dueDate: document.getElementById('invoiceDueDate').value || '', // YENƒ∞ EKLENEN: Vade tarihi
                status: '1. Onay Bekliyor',
                approvalStage: 1,
                createdBy: currentUser.email,
                createdAt: new Date().toISOString(),
                timestamp: Date.now()
            };

            const invoicesRef = dbRef(db, 'invoices');
            const newInvoiceRef = dbPush(invoicesRef);
            await dbSet(newInvoiceRef, invoiceData);
            
            await addLog(currentUser.email, 'Fatura Olu≈üturdu', `ID: ${sixDigitId}, Fatura No: ${invoiceData.invoiceNumber}`);
            
            // --- BURAYA EKLE (BA≈ûLANGI√á) ---
            // ƒ∞brahim'e Mail At
            await sendEmailNotification(
                'ibrahim', 
                'Yeni Fatura Onayƒ± Bekliyor', 
                `Sel√ßuk tarafƒ±ndan ${invoiceData.amount} TL tutarƒ±nda yeni bir fatura olu≈üturuldu. Fatura No: ${invoiceData.invoiceNumber}. L√ºtfen sisteme girip onaylayƒ±nƒ±z.`
            );
            // --- BURAYA EKLE (Bƒ∞Tƒ∞≈û) ---

            alert(`Fatura ba≈üarƒ±yla olu≈üturuldu! ID: ${sixDigitId}`);
            event.target.reset();
            loadSelcukData();
        };

        window.createInvoiceMehmet = async function(event) {
            event.preventDefault();
            
            const noteValue = document.getElementById('mehmetInvoiceNote').value.trim();
            let finalInvoiceId = generateSixDigitId();
            let linkedTransactionId = null;
            
            // NOT alanƒ±nda ID var mƒ± kontrol et
            if (noteValue) {
                // NOT alanƒ±ndaki ID'yi kontrol et (sadece rakamlardan olu≈üan 6 haneli bir deƒüer mi?)
                const potentialId = noteValue.match(/\b\d{6}\b/);
                
                if (potentialId) {
                    const searchId = potentialId[0];
                    
                    // Bu ID'ye sahip bir i≈ülem var mƒ± kontrol et
                    const transactionsRef = dbRef(db, 'transactions');
                    const snapshot = await dbGet(transactionsRef);
                    
                    let foundTransaction = null;
                    if (snapshot.exists()) {
                        const transactions = snapshot.val();
                        for (let transId in transactions) {
                            if (transactions[transId].customId === searchId) {
                                foundTransaction = { id: transId, ...transactions[transId] };
                                break;
                            }
                        }
                    }
                    
                    if (foundTransaction) {
                        // ƒ∞≈ülem bulundu - Fatura ID'sini i≈ülem ID'si ile e≈üle≈ütir
                        finalInvoiceId = searchId;
                        linkedTransactionId = foundTransaction.id;
                        
                        // ƒ∞≈ülemi fatura ile ili≈ükilendir
                        const transactionRef = dbRef(db, `transactions/${linkedTransactionId}`);
                        await dbUpdate(transactionRef, {
                            linkedInvoiceId: finalInvoiceId,
                            linkedInvoiceAt: new Date().toISOString()
                        });
                    } else {
                        // ƒ∞≈ülem bulunamaTamam, sadece kodun devamƒ±nƒ± veriyorum:


                        // ƒ∞≈ülem bulunamadƒ± - Kullanƒ±cƒ±yƒ± uyar
                        alert(`‚ö†Ô∏è UYARI: Girilen ID (${searchId}) sistemde bir i≈ülem ile e≈üle≈ümedi.\n\nƒ∞≈ülem-Fatura e≈üle≈ütirmesi yapmak istiyorsanƒ±z:\n1. √ñnce i≈ülem ID'sini kontrol edin\n2. Doƒüru ID'yi NOT alanƒ±na girin\n\nDevam etmek i√ßin "Tamam"a basƒ±n - fatura normal ID ile olu≈üturulacak.`);
                        // Kullanƒ±cƒ± devam etmek isterse normal akƒ±≈ü ile devam et
                    }
                }
            }
            
            const invoiceData = {
                customId: finalInvoiceId,
                invoiceNumber: document.getElementById('mehmetInvoiceNumber').value,
                invoiceDate: document.getElementById('mehmetInvoiceDate').value,
                amount: parseFloat(document.getElementById('mehmetInvoiceAmount').value),
                company: document.getElementById('mehmetCompanyInfo').value,
                note: noteValue,
                dueDate: document.getElementById('mehmetInvoiceDueDate').value || '', // YENƒ∞ EKLENEN: Vade tarihi
                status: '1. Onay Bekliyor',
                approvalStage: 1,
                createdBy: currentUser.email,
                createdAt: new Date().toISOString(),
                timestamp: Date.now()
            };
            
            // Eƒüer i≈ülem e≈üle≈ütirmesi yapƒ±ldƒ±ysa, bunu kaydet
            if (linkedTransactionId) {
                invoiceData.linkedTransactionId = linkedTransactionId;
                invoiceData.linkedTransactionCustomId = finalInvoiceId;
            }

            const invoicesRef = dbRef(db, 'invoices');
            const newInvoiceRef = dbPush(invoicesRef);
            await dbSet(newInvoiceRef, invoiceData);
            
            const logMessage = linkedTransactionId 
                ? `ID: ${finalInvoiceId}, Fatura No: ${invoiceData.invoiceNumber} (ƒ∞≈ülem ${finalInvoiceId} ile e≈üle≈ütirildi)`
                : `ID: ${finalInvoiceId}, Fatura No: ${invoiceData.invoiceNumber}`;
            
            await addLog(currentUser.email, 'Fatura Olu≈üturdu', logMessage);
            // ƒ∞brahim'e Mail At
            await sendEmailNotification(
                'ibrahim', 
                'Yeni Fatura Onayƒ± Bekliyor', 
                `Mehmet tarafƒ±ndan ${invoiceData.amount} TL tutarƒ±nda yeni bir fatura olu≈üturuldu. Fatura No: ${invoiceData.invoiceNumber}. L√ºtfen sisteme girip onaylayƒ±nƒ±z.`
            );
            const successMessage = linkedTransactionId
                ? `‚úÖ Fatura ba≈üarƒ±yla olu≈üturuldu!\n\nFatura ID: ${finalInvoiceId}\n‚úì ƒ∞≈ülem ID ${finalInvoiceId} ile e≈üle≈ütirildi\n‚úì ƒ∞≈ülem-Fatura baƒülantƒ±sƒ± kuruldu`
                : `‚úÖ Fatura ba≈üarƒ±yla olu≈üturuldu!\n\nFatura ID: ${finalInvoiceId}`;
            
            alert(successMessage);
            event.target.reset();
            loadMehmetData();
        };

        window.createTransaction = async function(event) {
            event.preventDefault();
            
            const noteValue = document.getElementById('transNote').value.trim();
            
            if (!noteValue) {
                alert('‚ö†Ô∏è Not/Maliyet alanƒ± zorunludur! L√ºtfen maliyet bilgisini girin.');
                return;
            }
            
            const sixDigitId = generateSixDigitId();
            
            const transactionData = {
                customId: sixDigitId,
                customerName: document.getElementById('customerName').value,
                imeiNumber: document.getElementById('imeiNumber').value,
                tcNumber: document.getElementById('tcNumber').value || '',
                brandModel: document.getElementById('brandModel').value,
                serviceType: document.getElementById('serviceType').value,
                amount: parseFloat(document.getElementById('transAmount').value),
                paymentMethod: document.getElementById('paymentMethod').value,
                paymentDate: document.getElementById('paymentDate').value || '',
                status: '1. Onay Bekliyor',
                approvalStage: 1,
                note: noteValue,
                createdBy: currentUser.email,
                createdAt: new Date().toISOString(),
                timestamp: Date.now()
            };

            const transactionsRef = dbRef(db, 'transactions');
            const newTransactionRef = dbPush(transactionsRef);
            await dbSet(newTransactionRef, transactionData);
            
            await addLog(currentUser.email, 'ƒ∞≈ülem Olu≈üturdu', `ID: ${sixDigitId}, Ad Soyad: ${transactionData.customerName}, IMEI: ${transactionData.imeiNumber}`);
            // ƒ∞brahim'e Mail At
            await sendEmailNotification(
                'ibrahim', 
                'Yeni ƒ∞≈ülem Onayƒ± Bekliyor', 
                `Mehmet tarafƒ±ndan ${transactionData.amount} TL tutarƒ±nda yeni bir servis i≈ülemi olu≈üturuldu. M√º≈üteri: ${transactionData.customerName}. L√ºtfen sisteme girip onaylayƒ±nƒ±z.`
            );
            alert(`ƒ∞≈ülem ba≈üarƒ±yla olu≈üturuldu! ID: ${sixDigitId}`);
            event.target.reset();
            document.getElementById('serviceType').value = '';
            loadMehmetData();
        };

        window.approveInvoice1 = async function(invoiceId) {
            const invoiceRef = dbRef(db, `invoices/${invoiceId}`);
            const snapshot = await dbGet(invoiceRef);
            const invoice = snapshot.val();
            
            showConfirmModal(
                '1. Onay - Fatura',
                `Fatura No: ${invoice.invoiceNumber}\nTutar: ${invoice.amount.toLocaleString('tr-TR')} ‚Ç∫\n\nBu faturayƒ± onaylamak istediƒüinizden emin misiniz?`,
                async () => {
                    await dbUpdate(invoiceRef, {
                        status: '2. Onay Bekliyor',
                        approvalStage: 2,
                        firstApprovedBy: currentUser.email,
                        firstApprovedAt: new Date().toISOString()
                    });
                    
                    await addLog(currentUser.email, 'Fatura 1. Onayladƒ±', `ID: ${invoice.customId}`);
                    await sendEmailNotification(
    'mahmut', 
    '2. Onay (√ñdeme) Bekleyen Fatura', 
    `ƒ∞brahim faturayƒ± onayladƒ±. ${invoice.amount} TL tutarƒ±ndaki faturanƒ±n √∂demesi/muhasebe onayƒ± bekleniyor. Fatura No: ${invoice.invoiceNumber}.`
);
                    alert('Fatura 1. onay verildi! 2. Onay bekleniyor.');
                    loadIbrahimData();
                }
            );
        };

        window.approveInvoice2 = async function(invoiceId) {
            const invoiceRef = dbRef(db, `invoices/${invoiceId}`);
            const snapshot = await dbGet(invoiceRef);
            const invoice = snapshot.val();
            
            showConfirmModal(
                '2. Onay - Fatura',
                `Fatura No: ${invoice.invoiceNumber}\nTutar: ${invoice.amount.toLocaleString('tr-TR')} ‚Ç∫\n\nBu faturayƒ± onaylamak istediƒüinizden emin misiniz? (Onaylandƒ±ktan sonra fatura tamamlanacaktƒ±r)`,
                async () => {
                    await dbUpdate(invoiceRef, {
                        status: 'Onaylandƒ±',
                        approvalStage: 3,
                        secondApprovedBy: currentUser.email,
                        secondApprovedAt: new Date().toISOString(),
                        completedAt: new Date().toISOString()
                    });
                    
                    await addLog(currentUser.email, 'Fatura 2. Onayladƒ± - Tamamlandƒ±', `ID: ${invoice.customId}`);
                    alert('Fatura 2. onay verildi! Fatura onaylandƒ± ve tamamlandƒ±.');
                    loadMahmutData();
                }
            );
        };

        window.approveTransaction1 = async function(transactionId) {
            const transactionRef = dbRef(db, `transactions/${transactionId}`);
            const snapshot = await dbGet(transactionRef);
            const transaction = snapshot.val();
            
            showConfirmModal(
                '1. Onay - ƒ∞≈ülem',
                `Ad Soyad: ${transaction.customerName}\nIMEI: ${transaction.imeiNumber}\nTutar: ${transaction.amount.toLocaleString('tr-TR')} ‚Ç∫\n\nBu i≈ülemi onaylamak istediƒüinizden emin misiniz?`,
                async () => {
                    await dbUpdate(transactionRef, {
                        status: '2. Onay Bekliyor',
                        approvalStage: 2,
                        firstApprovedBy: currentUser.email,
                        firstApprovedAt: new Date().toISOString()
                    });
                    
                    await addLog(currentUser.email, '1. Onay Verdi', `ID: ${transaction.customId}`);
                    // Muhasebeye (Mahmut) Mail At
await sendEmailNotification(
    'mahmut', 
    '2. Onay Bekleyen ƒ∞≈ülem Kaydƒ±', 
    `ƒ∞brahim i≈ülemi onayladƒ±. ${transaction.amount} TL tutarƒ±ndaki i≈ülemin sisteme i≈ülenmesi/onayƒ± bekleniyor. M√º≈üteri: ${transaction.customerName}.`
);
                    alert('1. Onay verildi! 2. Onay bekleniyor.');
                    loadIbrahimData();
                }
            );
        };

        window.approveTransaction2 = async function(transactionId) {
            const transactionRef = dbRef(db, `transactions/${transactionId}`);
            const snapshot = await dbGet(transactionRef);
            const transaction = snapshot.val();
            
            showConfirmModal(
                '2. Onay - ƒ∞≈ülem',
                `Ad Soyad: ${transaction.customerName}\nIMEI: ${transaction.imeiNumber}\nTutar: ${transaction.amount.toLocaleString('tr-TR')} ‚Ç∫\n\nBu i≈ülemi onaylamak istediƒüinizden emin misiniz? (ƒ∞≈ülem maliyet onayƒ± bekleme durumuna ge√ßecektir)`,
                async () => {
                    await dbUpdate(transactionRef, {
                        status: 'Maliyet Onayƒ± Bekliyor',
                        approvalStage: 3,
                        secondApprovedBy: currentUser.email,
                        secondApprovedAt: new Date().toISOString()
                    });
                    
                    await addLog(currentUser.email, '2. Onay Verdi', `ID: ${transaction.customId}`);
                    alert('2. Onay verildi! Maliyet onayƒ± bekleniyor.');
                    loadMahmutData();
                }
            );
        };

        window.approveCost = async function(transactionId) {
            const transactionRef = dbRef(db, `transactions/${transactionId}`);
            const snapshot = await dbGet(transactionRef);
            const transaction = snapshot.val();
            
            if (!transaction.note || transaction.note.trim() === '') {
                alert('‚ö†Ô∏è Not/Maliyet bilgisi eksik! 3. onay verilemez.');
                return;
            }
            
            showConfirmModal(
                '3. Onay - Maliyet √ñdeme',
                `Ad Soyad: ${transaction.customerName}\nIMEI: ${transaction.imeiNumber}\nMaliyet: ${transaction.note}\n\nMaliyeti √∂dediƒüinizi ve bu i≈ülemi tamamlamak istediƒüinizi onaylƒ±yor musunuz?`,
                async () => {
                    await dbUpdate(transactionRef, {
                        status: 'Tamamlandƒ± - Maliyet √ñdendi',
                        approvalStage: 4,
                        thirdApprovedBy: currentUser.email,
                        thirdApprovedAt: new Date().toISOString(),
                        completedAt: new Date().toISOString()
                    });
                    
                    await addLog(currentUser.email, '3. Onay Verdi - Maliyet √ñdendi', `ID: ${transaction.customId}, Maliyet: ${transaction.note}`);
                    alert('3. Onay (Maliyet) verildi! ƒ∞≈ülem tamamlandƒ±.');
                    loadMahmutData();
                }
            );
        };

        window.deleteRecord = async function(type, id) {
            showConfirmModal(
                'Kayƒ±t Silme',
                'Bu kaydƒ± silmek istediƒüinizden emin misiniz? Bu i≈ülem geri alƒ±namaz.',
                async () => {
                    const recordRef = dbRef(db, `${type}/${id}`);
                    await dbRemove(recordRef);
                    await addLog(currentUser.email, `${type} Sildi`, `ID: ${id}`);
                    alert('Kayƒ±t silindi!');
                    
                    if (currentUserRole === 'admin') loadAdminData();
                    else if (currentUserRole === 'mahmut') loadMahmutData();
                    else if (currentUserRole === 'ibrahim') loadIbrahimData();
                }
            );
        };

        async function loadAdminData() {
            const invoicesRef = dbRef(db, 'invoices');
            const transactionsRef = dbRef(db, 'transactions');
            const logsRef = dbRef(db, 'logs');

            dbOnValue(invoicesRef, (snapshot) => {
                const invoices = [];
                snapshot.forEach((child) => {
                    invoices.push({ id: child.key, ...child.val() });
                });
                
                document.getElementById('totalInvoices').textContent = invoices.length;
           const tbody = document.querySelector('#adminInvoicesTable tbody');
tbody.innerHTML = '';
invoices.sort((a, b) => b.timestamp - a.timestamp).forEach(invoice => {
    const linkedBadge = invoice.linkedTransactionId ? '<span class="linked-indicator">üîó ƒ∞≈ülem Baƒülantƒ±lƒ±</span>' : '';
    tbody.innerHTML += `
        <tr>
            <td><strong>${invoice.customId || invoice.id.substring(0, 6)}</strong>${linkedBadge}</td>
            <td>${invoice.invoiceNumber}</td>
            <td>${new Date(invoice.invoiceDate).toLocaleDateString('tr-TR')}</td>
            <td>${invoice.amount.toLocaleString('tr-TR')} ‚Ç∫</td>
            <td>${invoice.company}</td>
            <td>${invoice.note || '-'}</td>
            <td>${invoice.dueDate || '-'}</td> <!-- VADE S√úTUNU D√úZELTƒ∞LDƒ∞ -->
            <td>${invoice.createdBy}</td>
            <td><span class="badge ${getStatusBadge(invoice.status)}">${invoice.status}</span></td>
            <td><button class="action-btn btn-danger" onclick="deleteRecord('invoices', '${invoice.id}')">Sil</button></td>
        </tr>
    `;
});
            });

            dbOnValue(transactionsRef, (snapshot) => {
                const transactions = [];
                snapshot.forEach((child) => {
                    transactions.push({ id: child.key, ...child.val() });
                });
                
                document.getElementById('totalTransactions').textContent = transactions.length;
                
                const pending = transactions.filter(t => t.status.includes('Bekliyor')).length;
                document.getElementById('pendingApprovals').textContent = pending;
                
                const today = new Date().toDateString();
                const completedToday = transactions.filter(t => 
                    t.status.includes('Tamamlandƒ±') && 
                    t.completedAt &&
                    new Date(t.completedAt).toDateString() === today
                ).length;
                document.getElementById('completedToday').textContent = completedToday;
                
                const tbody = document.querySelector('#adminTransactionsTable tbody');
                tbody.innerHTML = '';
                transactions.sort((a, b) => b.timestamp - a.timestamp).forEach(transaction => {
                    const paymentDate = transaction.paymentDate ? new Date(transaction.paymentDate).toLocaleDateString('tr-TR') : '-';
                    const linkedBadge = transaction.linkedInvoiceId ? '<span class="linked-indicator">üîó Fatura Baƒülantƒ±lƒ±</span>' : '';
                    tbody.innerHTML += `
                        <tr>
                            <td><strong>${transaction.customId || transaction.id.substring(0, 6)}</strong>${linkedBadge}</td>
                            <td>${transaction.customerName}</td>
                            <td>${transaction.imeiNumber}</td>
                            <td>${transaction.tcNumber || '-'}</td>
                            <td>${transaction.brandModel}</td>
                            <td>${transaction.serviceType || '-'}</td>
                            <td>${transaction.amount.toLocaleString('tr-TR')} ‚Ç∫</td>
                            <td>${transaction.paymentMethod}</td>
                            <td>${paymentDate}</td>
                            <td>${transaction.note || '-'}</td>
                            <td>${transaction.createdBy}</td>
                            <td><span class="badge ${getStatusBadge(transaction.status)}">${transaction.status}</span></td>
                            <td><button class="action-btn btn-danger" onclick="deleteRecord('transactions', '${transaction.id}')">Sil</button></td>
                        </tr>
                    `;
                });

                const costPendingTbody = document.querySelector('#adminCostPendingTable tbody');
                costPendingTbody.innerHTML = '';
                const costPending = transactions.filter(t => t.status === 'Maliyet Onayƒ± Bekliyor');
                costPending.sort((a, b) => b.timestamp - a.timestamp).forEach(transaction => {
                    costPendingTbody.innerHTML += `
                        <tr>
                            <td><strong>${transaction.customId || transaction.id.substring(0, 6)}</strong></td>
                            <td>${transaction.customerName}</td>
                            <td>${transaction.imeiNumber}</td>
                            <td>${transaction.tcNumber || '-'}</td>
                            <td>${transaction.brandModel}</td>
                            <td>${transaction.serviceType || '-'}</td>
                            <td>${transaction.amount.toLocaleString('tr-TR')} ‚Ç∫</td>
                            <td><div class="cost-info">${transaction.note || '-'}</div></td>
                            <td><span class="badge badge-cost-pending">${transaction.status}</span></td>
                        </tr>
                    `;
                });

                const costPaidTbody = document.querySelector('#adminCostPaidTable tbody');
                costPaidTbody.innerHTML = '';
                const costPaid = transactions.filter(t => t.status === 'Tamamlandƒ± - Maliyet √ñdendi');
                costPaid.sort((a, b) => b.timestamp - a.timestamp).forEach(transaction => {
                    costPaidTbody.innerHTML += `
                        <tr>
                            <td><strong>${transaction.customId || transaction.id.substring(0, 6)}</strong></td>
                            <td>${transaction.customerName}</td>
                            <td>${transaction.imeiNumber}</td>
                            <td>${transaction.tcNumber || '-'}</td>
                            <td>${transaction.brandModel}</td>
                            <td>${transaction.serviceType || '-'}</td>
                            <td>${transaction.amount.toLocaleString('tr-TR')} ‚Ç∫</td>
                            <td><div class="cost-info">${transaction.note || '-'}</div></td>
                            <td><span class="badge badge-cost-paid">${transaction.status}</span></td>
                            <td>${transaction.thirdApprovedAt ? new Date(transaction.thirdApprovedAt).toLocaleString('tr-TR') : '-'}</td>
                        </tr>
                    `;
                });
            });

            dbOnValue(logsRef, (snapshot) => {
                const logs = [];
                snapshot.forEach((child) => {
                    logs.push(child.val());
                });
                
                const tbody = document.querySelector('#adminLogsTable tbody');
                tbody.innerHTML = '';
                logs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).slice(0, 100).forEach(log => {
                    const date = new Date(log.timestamp);
                    tbody.innerHTML += `
                        <tr>
                            <td>${date.toLocaleString('tr-TR')}</td>
                            <td>${log.userId}</td>
                            <td>${log.action}</td>
                            <td>${log.details}</td>
                        </tr>
                    `;
                });
            });

            loadStatusOptions();
            loadServiceTypes();
        }

        function loadSelcukData() {
            const invoicesRef = dbRef(db, 'invoices');
            dbOnValue(invoicesRef, (snapshot) => {
                const invoices = [];
                snapshot.forEach((child) => {
                    const invoice = child.val();
                    if (invoice.createdBy === currentUser.email) {
                        invoices.push({ id: child.key, ...invoice });
                    }
                });
const tbody = document.querySelector('#selcukInvoicesTable tbody');
tbody.innerHTML = '';
invoices.sort((a, b) => b.timestamp - a.timestamp).forEach(invoice => {
    const canEdit = invoice.status === '1. Onay Bekliyor';
    const linkedBadge = invoice.linkedTransactionId ? '<span class="linked-indicator">üîó ƒ∞≈ülem Baƒülantƒ±lƒ±</span>' : '';
    tbody.innerHTML += `
        <tr>
            <td><strong>${invoice.customId || invoice.id.substring(0, 6)}</strong>${linkedBadge}</td>
            <td>${invoice.invoiceNumber}</td>
            <td>${new Date(invoice.invoiceDate).toLocaleDateString('tr-TR')}</td>
            <td>${invoice.amount.toLocaleString('tr-TR')} ‚Ç∫</td>
            <td>${invoice.company}</td>
            <td>${invoice.note || '-'}</td>
            <td>${invoice.dueDate || '-'}</td> <!-- VADE S√úTUNU D√úZELTƒ∞LDƒ∞ -->
            <td><span class="badge ${getStatusBadge(invoice.status)}">${invoice.status}</span></td>
            <td>
                ${canEdit ? `<button class="action-btn btn-warning" onclick="openEditInvoiceModal('${invoice.id}')">‚úèÔ∏è D√ºzenle</button>` : '<span style="color: #9ca3af; font-size: 12px;">D√ºzenlenemez</span>'}
            </td>
        </tr>
    `;
});
            });
        }

        function loadMehmetData() {
            const transactionsRef = dbRef(db, 'transactions');
            const invoicesRef = dbRef(db, 'invoices');

            dbOnValue(transactionsRef, (snapshot) => {
                const transactions = [];
                snapshot.forEach((child) => {
                    const transaction = child.val();
                    if (transaction.createdBy === currentUser.email) {
                        transactions.push({ id: child.key, ...transaction });
                    }
                });
                
                const tbody = document.querySelector('#mehmetTransactionsTable tbody');
                tbody.innerHTML = '';
                transactions.sort((a, b) => b.timestamp - a.timestamp).forEach(transaction => {
                    const paymentDate = transaction.paymentDate ? new Date(transaction.paymentDate).toLocaleDateString('tr-TR') : '-';
                    const canEdit = transaction.status === '1. Onay Bekliyor';
                    const linkedBadge = transaction.linkedInvoiceId ? '<span class="linked-indicator">üîó Fatura Baƒülantƒ±lƒ±</span>' : '';
                    tbody.innerHTML += `
                        <tr>
                            <td><strong>${transaction.customId || transaction.id.substring(0, 6)}</strong>${linkedBadge}</td>
                            <td>${transaction.customerName}</td>
                            <td>${transaction.imeiNumber}</td>
                            <td>${transaction.tcNumber || '-'}</td>
                            <td>${transaction.brandModel}</td>
                            <td>${transaction.serviceType || '-'}</td>
                            <td>${transaction.amount.toLocaleString('tr-TR')} ‚Ç∫</td>
                            <td>${transaction.paymentMethod}</td>
                            <td>${paymentDate}</td>
                            <td><div class="cost-info">${transaction.note || '-'}</div></td>
                            <td><span class="badge ${getStatusBadge(transaction.status)}">${transaction.status}</span></td>
                            <td>
                                ${canEdit ? `<button class="action-btn btn-warning" onclick="openEditTransactionModal('${transaction.id}')">‚úèÔ∏è D√ºzenle</button>` : '<span style="color: #9ca3af; font-size: 12px;">D√ºzenlenemez</span>'}
                            </td>
                        </tr>
                    `;
                });
            });

            dbOnValue(invoicesRef, (snapshot) => {
                const invoices = [];
                snapshot.forEach((child) => {
                    const invoice = child.val();
                    if (invoice.createdBy === currentUser.email) {
                        invoices.push({ id: child.key, ...invoice });
                    }
                });
                
              const tbody = document.querySelector('#mehmetInvoicesTable tbody');
tbody.innerHTML = '';
invoices.sort((a, b) => b.timestamp - a.timestamp).forEach(invoice => {
    const canEdit = invoice.status === '1. Onay Bekliyor';
    const linkedBadge = invoice.linkedTransactionId ? '<span class="linked-indicator">üîó ƒ∞≈ülem Baƒülantƒ±lƒ±</span>' : '';
    tbody.innerHTML += `
        <tr>
            <td><strong>${invoice.customId || invoice.id.substring(0, 6)}</strong>${linkedBadge}</td>
            <td>${invoice.invoiceNumber}</td>
            <td>${new Date(invoice.invoiceDate).toLocaleDateString('tr-TR')}</td>
            <td>${invoice.amount.toLocaleString('tr-TR')} ‚Ç∫</td>
            <td>${invoice.company}</td>
            <td>${invoice.note || '-'}</td>
            <td>${invoice.dueDate || '-'}</td> <!-- VADE S√úTUNU D√úZELTƒ∞LDƒ∞ -->
            <td><span class="badge ${getStatusBadge(invoice.status)}">${invoice.status}</span></td>
            <td>
                ${canEdit ? `<button class="action-btn btn-warning" onclick="openEditInvoiceModal('${invoice.id}')">‚úèÔ∏è D√ºzenle</button>` : '<span style="color: #9ca3af; font-size: 12px;">D√ºzenlenemez</span>'}
            </td>
        </tr>
    `;
});
            });
        }

        function loadIbrahimData() {
            const transactionsRef = dbRef(db, 'transactions');
            const invoicesRef = dbRef(db, 'invoices');

            dbOnValue(transactionsRef, (snapshot) => {
                const allTransactions = [];
                const pendingTransactions = [];
                const approvedTransactions = [];

                snapshot.forEach((child) => {
                    const transaction = { id: child.key, ...child.val() };
                    allTransactions.push(transaction);
                    
                    if (transaction.status === '1. Onay Bekliyor') {
                        pendingTransactions.push(transaction);
                    } else if (transaction.firstApprovedBy === currentUser.email) {
                        approvedTransactions.push(transaction);
                    }
                });

                document.getElementById('ibrahimPending').textContent = pendingTransactions.length;
                document.getElementById('ibrahimApproved').textContent = approvedTransactions.length;
                
                const pendingTbody = document.querySelector('#ibrahimPendingTable tbody');
                pendingTbody.innerHTML = '';
                pendingTransactions.sort((a, b) => b.timestamp - a.timestamp).forEach(transaction => {
                    const paymentDate = transaction.paymentDate ? new Date(transaction.paymentDate).toLocaleDateString('tr-TR') : '-';
                    const linkedBadge = transaction.linkedInvoiceId ? '<span class="linked-indicator">üîó Fatura Baƒülantƒ±lƒ±</span>' : '';
                    pendingTbody.innerHTML += `
                        <tr>
                            <td><strong>${transaction.customId || transaction.id.substring(0, 6)}</strong>${linkedBadge}</td>
                            <td>${transaction.customerName}</td>
                            <td>${transaction.imeiNumber}</td>
                            <td>${transaction.tcNumber || '-'}</td>
                            <td>${transaction.brandModel}</td>
                            <td>${transaction.serviceType || '-'}</td>
                            <td>${transaction.amount.toLocaleString('tr-TR')} ‚Ç∫</td>
                            <td>${transaction.paymentMethod}</td>
                            <td>${paymentDate}</td>
                            <td><div class="cost-info">${transaction.note || '-'}</div></td>
                            <td><span class="badge ${getStatusBadge(transaction.status)}">${transaction.status}</span></td>
                            <td>
                                <button class="action-btn btn-success" onclick="approveTransaction1('${transaction.id}')">1. Onay Ver</button>
                            </td>
                        </tr>
                    `;
                });

                const approvedTbody = document.querySelector('#ibrahimApprovedTable tbody');
                approvedTbody.innerHTML = '';
                approvedTransactions.sort((a, b) => b.timestamp - a.timestamp).forEach(transaction => {
                    const paymentDate = transaction.paymentDate ? new Date(transaction.paymentDate).toLocaleDateString('tr-TR') : '-';
                    const linkedBadge = transaction.linkedInvoiceId ? '<span class="linked-indicator">üîó Fatura Baƒülantƒ±lƒ±</span>' : '';
                    approvedTbody.innerHTML += `
                        <tr>
                            <td><strong>${transaction.customId || transaction.id.substring(0, 6)}</strong>${linkedBadge}</td>
                            <td>${transaction.customerName}</td>
                            <td>${transaction.imeiNumber}</td>
                            <td>${transaction.tcNumber || '-'}</td>
                            <td>${transaction.brandModel}</td>
                            <td>${transaction.serviceType || '-'}</td>
                            <td>${transaction.amount.toLocaleString('tr-TR')} ‚Ç∫</td>
                            <td>${transaction.paymentMethod}</td>
                            <td>${paymentDate}</td>
                            <td><div class="cost-info">${transaction.note || '-'}</div></td>
                            <td><span class="badge ${getStatusBadge(transaction.status)}">${transaction.status}</span></td>
                            <td>
                                <button class="action-btn btn-danger" onclick="deleteRecord('transactions', '${transaction.id}')">Sil</button>
                            </td>
                        </tr>
                    `;
                });
            });

            dbOnValue(invoicesRef, (snapshot) => {
                const allInvoices = [];
                const pendingInvoices = [];
                const approvedInvoices = [];

                snapshot.forEach((child) => {
                    const invoice = { id: child.key, ...child.val() };
                    allInvoices.push(invoice);
                    
                    if (invoice.status === '1. Onay Bekliyor') {
                        pendingInvoices.push(invoice);
                    } else if (invoice.firstApprovedBy === currentUser.email) {
                        approvedInvoices.push(invoice);
                    }
                });

                document.getElementById('ibrahimPendingInvoices').textContent = pendingInvoices.length;
                document.getElementById('ibrahimApprovedInvoices').textContent = approvedInvoices.length;
                
         const pendingInvoicesTbody = document.querySelector('#ibrahimInvoicesPendingTable tbody');
pendingInvoicesTbody.innerHTML = '';
pendingInvoices.sort((a, b) => b.timestamp - a.timestamp).forEach(invoice => {
    const linkedBadge = invoice.linkedTransactionId ? '<span class="linked-indicator">üîó ƒ∞≈ülem Baƒülantƒ±lƒ±</span>' : '';
    pendingInvoicesTbody.innerHTML += `
        <tr>
            <td><strong>${invoice.customId || invoice.id.substring(0, 6)}</strong>${linkedBadge}</td>
            <td>${invoice.invoiceNumber}</td>
            <td>${new Date(invoice.invoiceDate).toLocaleDateString('tr-TR')}</td>
            <td>${invoice.amount.toLocaleString('tr-TR')} ‚Ç∫</td>
            <td>${invoice.company}</td>
            <td>${invoice.note || '-'}</td>
            <td>${invoice.dueDate || '-'}</td> <!-- VADE S√úTUNU D√úZELTƒ∞LDƒ∞ -->
            <td>${invoice.createdBy}</td> <!-- OLU≈ûTURAN S√úTUNU D√úZELTƒ∞LDƒ∞ -->
            <td><span class="badge ${getStatusBadge(invoice.status)}">${invoice.status}</span></td>
            <td>
                <button class="action-btn btn-success" onclick="approveInvoice1('${invoice.id}')">1. Onay Ver</button>
            </td>
        </tr>
    `;
});

const approvedInvoicesTbody = document.querySelector('#ibrahimInvoicesApprovedTable tbody');
approvedInvoicesTbody.innerHTML = '';
approvedInvoices.sort((a, b) => b.timestamp - a.timestamp).forEach(invoice => {
    const linkedBadge = invoice.linkedTransactionId ? '<span class="linked-indicator">üîó ƒ∞≈ülem Baƒülantƒ±lƒ±</span>' : '';
    approvedInvoicesTbody.innerHTML += `
        <tr>
            <td><strong>${invoice.customId || invoice.id.substring(0, 6)}</strong>${linkedBadge}</td>
            <td>${invoice.invoiceNumber}</td>
            <td>${new Date(invoice.invoiceDate).toLocaleDateString('tr-TR')}</td>
            <td>${invoice.amount.toLocaleString('tr-TR')} ‚Ç∫</td>
            <td>${invoice.company}</td>
            <td>${invoice.note || '-'}</td>
            <td>${invoice.dueDate || '-'}</td> <!-- VADE S√úTUNU D√úZELTƒ∞LDƒ∞ -->
            <td>${invoice.createdBy}</td> <!-- OLU≈ûTURAN S√úTUNU D√úZELTƒ∞LDƒ∞ -->
            <td><span class="badge ${getStatusBadge(invoice.status)}">${invoice.status}</span></td>
        </tr>
    `;
});
            });
        }

function loadMahmutData() {
    const invoicesRef = dbRef(db, 'invoices');
    const transactionsRef = dbRef(db, 'transactions');

    dbOnValue(invoicesRef, (snapshot) => {
        const allInvoices = [];
        const pendingInvoices = [];
        const approvedInvoices = [];

        snapshot.forEach((child) => {
            const invoice = { id: child.key, ...child.val() };
            allInvoices.push(invoice);
            
            if (invoice.status === '2. Onay Bekliyor') {
                pendingInvoices.push(invoice);
            } else if (invoice.secondApprovedBy === currentUser.email) {
                approvedInvoices.push(invoice);
            }
        });

        document.getElementById('mahmutPendingInvoices').textContent = pendingInvoices.length;
        
        // HATA D√úZELTME: approvedInvoices'ƒ±n dizi olduƒüundan emin ol
        const safeApprovedInvoices = Array.isArray(approvedInvoices) ? approvedInvoices : [];
        
        const pendingTbody = document.querySelector('#mahmutInvoicesPendingTable tbody');
        pendingTbody.innerHTML = '';
        pendingInvoices.sort((a, b) => b.timestamp - a.timestamp).forEach(invoice => {
            const linkedBadge = invoice.linkedTransactionId ? '<span class="linked-indicator">üîó ƒ∞≈ülem Baƒülantƒ±lƒ±</span>' : '';
            pendingTbody.innerHTML += `
                <tr>
                    <td><strong>${invoice.customId || invoice.id.substring(0, 6)}</strong>${linkedBadge}</td>
                    <td>${invoice.invoiceNumber}</td>
                    <td>${new Date(invoice.invoiceDate).toLocaleDateString('tr-TR')}</td>
                    <td>${invoice.amount.toLocaleString('tr-TR')} ‚Ç∫</td>
                    <td>${invoice.company}</td>
                    <td>${invoice.note || '-'}</td>
                    <td>${invoice.dueDate || '-'}</td>
                    <td>${invoice.createdBy}</td>
                    <td><span class="badge ${getStatusBadge(invoice.status)}">${invoice.status}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn btn-success" onclick="approveInvoice2('${invoice.id}')">2. Onayla</button>
                            <button class="action-btn btn-danger" onclick="deleteRecord('invoices', '${invoice.id}')">Sil</button>
                        </div>
                    </td>
                </tr>
            `;
        });

        const approvedTbody = document.querySelector('#mahmutInvoicesApprovedTable tbody');
        approvedTbody.innerHTML = '';
        
        // D√úZELTƒ∞LMƒ∞≈û KISIM: safeApprovedInvoices kullanƒ±lƒ±yor
        safeApprovedInvoices.sort((a, b) => b.timestamp - a.timestamp).forEach(invoice => {
            const linkedBadge = invoice.linkedTransactionId ? '<span class="linked-indicator">üîó ƒ∞≈ülem Baƒülantƒ±lƒ±</span>' : '';
            approvedTbody.innerHTML += `
                <tr>
                    <td><strong>${invoice.customId || invoice.id.substring(0, 6)}</strong>${linkedBadge}</td>
                    <td>${invoice.invoiceNumber}</td>
                    <td>${new Date(invoice.invoiceDate).toLocaleDateString('tr-TR')}</td>
                    <td>${invoice.amount.toLocaleString('tr-TR')} ‚Ç∫</td>
                    <td>${invoice.company}</td>
                    <td>${invoice.note || '-'}</td>
                    <td>${invoice.dueDate || '-'}</td>
                    <td>${invoice.createdBy}</td>
                    <td><span class="badge ${getStatusBadge(invoice.status)}">${invoice.status}</span></td>
                    <td>
                        <button class="action-btn btn-danger" onclick="deleteRecord('invoices', '${invoice.id}')">Sil</button>
                    </td>
                </tr>
            `;
        });
    });

    // Aynƒ± kontrol√º transactions i√ßin de yapƒ±n
    dbOnValue(transactionsRef, (snapshot) => {
        const allTransactions = [];
        const pendingTransactions2 = [];
        const approvedTransactions = [];
        const costPendingTransactions = [];
        const costPaidTransactions = [];

        snapshot.forEach((child) => {
            const transaction = { id: child.key, ...child.val() };
            allTransactions.push(transaction);
            
            if (transaction.status === '2. Onay Bekliyor') {
                pendingTransactions2.push(transaction);
            } else if (transaction.secondApprovedBy === currentUser.email && transaction.status !== 'Maliyet Onayƒ± Bekliyor' && transaction.status !== 'Tamamlandƒ± - Maliyet √ñdendi') {
                approvedTransactions.push(transaction);
            } else if (transaction.status === 'Maliyet Onayƒ± Bekliyor') {
                costPendingTransactions.push(transaction);
            } else if (transaction.status === 'Tamamlandƒ± - Maliyet √ñdendi') {
                costPaidTransactions.push(transaction);
            }
        });

        document.getElementById('mahmutPendingTransactions').textContent = pendingTransactions2.length;
        document.getElementById('mahmutCostPending').textContent = costPendingTransactions.length;
        document.getElementById('mahmutCostPaid').textContent = costPaidTransactions.length;
        
        // G√ºvenli dizi kontrolleri
        const safePendingTransactions2 = Array.isArray(pendingTransactions2) ? pendingTransactions2 : [];
        const safeApprovedTransactions = Array.isArray(approvedTransactions) ? approvedTransactions : [];
        const safeCostPendingTransactions = Array.isArray(costPendingTransactions) ? costPendingTransactions : [];
        const safeCostPaidTransactions = Array.isArray(costPaidTransactions) ? costPaidTransactions : [];
        
        const pendingTbody = document.querySelector('#mahmutTransactionsPendingTable tbody');
        pendingTbody.innerHTML = '';
        safePendingTransactions2.sort((a, b) => b.timestamp - a.timestamp).forEach(transaction => {
            const paymentDate = transaction.paymentDate ? new Date(transaction.paymentDate).toLocaleDateString('tr-TR') : '-';
            const linkedBadge = transaction.linkedInvoiceId ? '<span class="linked-indicator">üîó Fatura Baƒülantƒ±lƒ±</span>' : '';
            pendingTbody.innerHTML += `
                <tr>
                    <td><strong>${transaction.customId || transaction.id.substring(0, 6)}</strong>${linkedBadge}</td>
                    <td>${transaction.customerName}</td>
                    <td>${transaction.imeiNumber}</td>
                    <td>${transaction.tcNumber || '-'}</td>
                    <td>${transaction.brandModel}</td>
                    <td>${transaction.serviceType || '-'}</td>
                    <td>${transaction.amount.toLocaleString('tr-TR')} ‚Ç∫</td>
                    <td>${transaction.paymentMethod}</td>
                    <td>${paymentDate}</td>
                    <td><div class="cost-info">${transaction.note || '-'}</div></td>
                    <td><span class="badge ${getStatusBadge(transaction.status)}">${transaction.status}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn btn-success" onclick="approveTransaction2('${transaction.id}')">2. Onayla</button>
                            <button class="action-btn btn-danger" onclick="deleteRecord('transactions', '${transaction.id}')">Sil</button>
                        </div>
                    </td>
                </tr>
            `;
        });

        const costPendingTbody = document.querySelector('#mahmutCostPendingTable tbody');
        costPendingTbody.innerHTML = '';
        safeCostPendingTransactions.sort((a, b) => b.timestamp - a.timestamp).forEach(transaction => {
            const linkedBadge = transaction.linkedInvoiceId ? '<span class="linked-indicator">üîó Fatura Baƒülantƒ±lƒ±</span>' : '';
            costPendingTbody.innerHTML += `
                <tr>
                    <td><strong>${transaction.customId || transaction.id.substring(0, 6)}</strong>${linkedBadge}</td>
                    <td>${transaction.customerName}</td>
                    <td>${transaction.imeiNumber}</td>
                    <td>${transaction.tcNumber || '-'}</td>
                    <td>${transaction.brandModel}</td>
                    <td>${transaction.serviceType || '-'}</td>
                    <td>${transaction.amount.toLocaleString('tr-TR')} ‚Ç∫</td>
                    <td><div class="cost-info"><strong>Maliyet:</strong> ${transaction.note || 'Bilgi yok'}</div></td>
                    <td><span class="badge badge-cost-pending">${transaction.status}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn btn-success" onclick="approveCost('${transaction.id}')">3. Onay - Maliyet √ñde</button>
                        </div>
                    </td>
                </tr>
            `;
        });

        const approvedTbody = document.querySelector('#mahmutTransactionsApprovedTable tbody');
        approvedTbody.innerHTML = '';
        safeApprovedTransactions.sort((a, b) => b.timestamp - a.timestamp).forEach(transaction => {
            const paymentDate = transaction.paymentDate ? new Date(transaction.paymentDate).toLocaleDateString('tr-TR') : '-';
            const linkedBadge = transaction.linkedInvoiceId ? '<span class="linked-indicator">üîó Fatura Baƒülantƒ±lƒ±</span>' : '';
            approvedTbody.innerHTML += `
                <tr>
                    <td><strong>${transaction.customId || transaction.id.substring(0, 6)}</strong>${linkedBadge}</td>
                    <td>${transaction.customerName}</td>
                    <td>${transaction.imeiNumber}</td>
                    <td>${transaction.tcNumber || '-'}</td>
                    <td>${transaction.brandModel}</td>
                    <td>${transaction.serviceType || '-'}</td>
                    <td>${transaction.amount.toLocaleString('tr-TR')} ‚Ç∫</td>
                    <td>${transaction.paymentMethod}</td>
                    <td>${paymentDate}</td>
                    <td><div class="cost-info">${transaction.note || '-'}</div></td>
                    <td><span class="badge ${getStatusBadge(transaction.status)}">${transaction.status}</span></td>
                    <td>
                        <button class="action-btn btn-danger" onclick="deleteRecord('transactions', '${transaction.id}')">Sil</button>
                    </td>
                </tr>
            `;
        });

        const costPaidTbody = document.querySelector('#mahmutCostPaidTable tbody');
        costPaidTbody.innerHTML = '';
        safeCostPaidTransactions.sort((a, b) => b.timestamp - a.timestamp).forEach(transaction => {
            const linkedBadge = transaction.linkedInvoiceId ? '<span class="linked-indicator">üîó Fatura Baƒülantƒ±lƒ±</span>' : '';
            costPaidTbody.innerHTML += `
                <tr>
                    <td><strong>${transaction.customId || transaction.id.substring(0, 6)}</strong>${linkedBadge}</td>
                    <td>${transaction.customerName}</td>
                    <td>${transaction.imeiNumber}</td>
                    <td>${transaction.tcNumber || '-'}</td>
                    <td>${transaction.brandModel}</td>
                    <td>${transaction.serviceType || '-'}</td>
                    <td>${transaction.amount.toLocaleString('tr-TR')} ‚Ç∫</td>
                    <td><div class="cost-info">${transaction.note || '-'}</div></td>
                    <td><span class="badge badge-cost-paid">${transaction.status}</span></td>
                    <td>${transaction.thirdApprovedAt ? new Date(transaction.thirdApprovedAt).toLocaleString('tr-TR') : '-'}</td>
                </tr>
            `;
        });
    });
}

        function loadViewerData() {
    const invoicesRef = dbRef(db, 'invoices');
    const transactionsRef = dbRef(db, 'transactions');

    dbOnValue(invoicesRef, (snapshot) => {
        const invoices = [];
        snapshot.forEach((child) => {
            invoices.push({ id: child.key, ...child.val() });
        });
        
        document.getElementById('viewerTotalInvoices').textContent = invoices.length;
        
      const tbody = document.querySelector('#viewerInvoicesTable tbody');
tbody.innerHTML = '';
invoices.sort((a, b) => b.timestamp - a.timestamp).forEach(invoice => {
    const lastEdited = invoice.lastEditedAt ? new Date(invoice.lastEditedAt).toLocaleString('tr-TR') : 
                      invoice.createdAt ? new Date(invoice.createdAt).toLocaleString('tr-TR') : '-';
    const linkedBadge = invoice.linkedTransactionId ? '<span class="linked-indicator">üîó ƒ∞≈ülem Baƒülantƒ±lƒ±</span>' : '';
    
    tbody.innerHTML += `
        <tr>
            <td><strong>${invoice.customId || invoice.id.substring(0, 6)}</strong>${linkedBadge}</td>
            <td>${invoice.invoiceNumber}</td>
            <td>${new Date(invoice.invoiceDate).toLocaleDateString('tr-TR')}</td>
            <td>${invoice.amount.toLocaleString('tr-TR')} ‚Ç∫</td>
            <td>${invoice.company}</td>
            <td>${invoice.note || '-'}</td>
            <td>${invoice.dueDate || '-'}</td> <!-- VADE S√úTUNU D√úZELTƒ∞LDƒ∞ -->
            <td>${invoice.createdBy}</td>
            <td><span class="badge ${getStatusBadge(invoice.status)}">${invoice.status}</span></td>
            <td>${lastEdited}</td>
        </tr>
    `;
});
    });

    dbOnValue(transactionsRef, (snapshot) => {
        const transactions = [];
        snapshot.forEach((child) => {
            transactions.push({ id: child.key, ...child.val() });
        });
        
        document.getElementById('viewerTotalTransactions').textContent = transactions.length;
        
        const pending = transactions.filter(t => t.status.includes('Bekliyor')).length;
        document.getElementById('viewerPendingApprovals').textContent = pending;
        
        const today = new Date().toDateString();
        const completedToday = transactions.filter(t => 
            t.status.includes('Tamamlandƒ±') && 
            t.completedAt &&
            new Date(t.completedAt).toDateString() === today
        ).length;
        document.getElementById('viewerCompletedToday').textContent = completedToday;
        
        // T√ºm ƒ∞≈ülemler Tablosu
        const tbody = document.querySelector('#viewerTransactionsTable tbody');
        tbody.innerHTML = '';
        transactions.sort((a, b) => b.timestamp - a.timestamp).forEach(transaction => {
            const paymentDate = transaction.paymentDate ? new Date(transaction.paymentDate).toLocaleDateString('tr-TR') : '-';
            const lastEdited = transaction.lastEditedAt ? new Date(transaction.lastEditedAt).toLocaleString('tr-TR') : 
                              transaction.createdAt ? new Date(transaction.createdAt).toLocaleString('tr-TR') : '-';
            const linkedBadge = transaction.linkedInvoiceId ? '<span class="linked-indicator">üîó Fatura Baƒülantƒ±lƒ±</span>' : '';
            
            tbody.innerHTML += `
                <tr>
                    <td><strong>${transaction.customId || transaction.id.substring(0, 6)}</strong>${linkedBadge}</td>
                    <td>${transaction.customerName}</td>
                    <td>${transaction.imeiNumber}</td>
                    <td>${transaction.tcNumber || '-'}</td>
                    <td>${transaction.brandModel}</td>
                    <td>${transaction.serviceType || '-'}</td>
                    <td>${transaction.amount.toLocaleString('tr-TR')} ‚Ç∫</td>
                    <td>${transaction.paymentMethod}</td>
                    <td>${paymentDate}</td>
                    <td><div class="cost-info">${transaction.note || '-'}</div></td>
                    <td>${transaction.createdBy}</td>
                    <td><span class="badge ${getStatusBadge(transaction.status)}">${transaction.status}</span></td>
                    <td>${lastEdited}</td>
                </tr>
            `;
        });

        // Maliyet Bekleyenler Tablosu
        const costPendingTbody = document.querySelector('#viewerCostPendingTable tbody');
        costPendingTbody.innerHTML = '';
        const costPending = transactions.filter(t => t.status === 'Maliyet Onayƒ± Bekliyor');
        costPending.sort((a, b) => b.timestamp - a.timestamp).forEach(transaction => {
            const secondApprovalDate = transaction.secondApprovedAt ? new Date(transaction.secondApprovedAt).toLocaleString('tr-TR') : '-';
            const linkedBadge = transaction.linkedInvoiceId ? '<span class="linked-indicator">üîó Fatura Baƒülantƒ±lƒ±</span>' : '';
            
            costPendingTbody.innerHTML += `
                <tr>
                    <td><strong>${transaction.customId || transaction.id.substring(0, 6)}</strong>${linkedBadge}</td>
                    <td>${transaction.customerName}</td>
                    <td>${transaction.imeiNumber}</td>
                    <td>${transaction.tcNumber || '-'}</td>
                    <td>${transaction.brandModel}</td>
                    <td>${transaction.serviceType || '-'}</td>
                    <td>${transaction.amount.toLocaleString('tr-TR')} ‚Ç∫</td>
                    <td><div class="cost-info">${transaction.note || '-'}</div></td>
                    <td><span class="badge badge-cost-pending">${transaction.status}</span></td>
                    <td>${secondApprovalDate}</td>
                </tr>
            `;
        });

        // Maliyet √ñdenenler Tablosu
        const costPaidTbody = document.querySelector('#viewerCostPaidTable tbody');
        costPaidTbody.innerHTML = '';
        const costPaid = transactions.filter(t => t.status === 'Tamamlandƒ± - Maliyet √ñdendi');
        costPaid.sort((a, b) => b.timestamp - a.timestamp).forEach(transaction => {
            const thirdApprovalDate = transaction.thirdApprovedAt ? new Date(transaction.thirdApprovedAt).toLocaleString('tr-TR') : '-';
            const linkedBadge = transaction.linkedInvoiceId ? '<span class="linked-indicator">üîó Fatura Baƒülantƒ±lƒ±</span>' : '';
            
            costPaidTbody.innerHTML += `
                <tr>
                    <td><strong>${transaction.customId || transaction.id.substring(0, 6)}</strong>${linkedBadge}</td>
                    <td>${transaction.customerName}</td>
                    <td>${transaction.imeiNumber}</td>
                    <td>${transaction.tcNumber || '-'}</td>
                    <td>${transaction.brandModel}</td>
                    <td>${transaction.serviceType || '-'}</td>
                    <td>${transaction.amount.toLocaleString('tr-TR')} ‚Ç∫</td>
                    <td><div class="cost-info">${transaction.note || '-'}</div></td>
                    <td><span class="badge badge-cost-paid">${transaction.status}</span></td>
                    <td>${thirdApprovalDate}</td>
                </tr>
            `;
        });
    });
}

        function loadStatusOptions() {
            const statusRef = dbRef(db, 'statusOptions');
            dbOnValue(statusRef, (snapshot) => {
                const options = [];
                snapshot.forEach((child) => {
                    options.push({ id: child.key, value: child.val() });
                });
                
                if (currentUserRole === 'admin') {
                    const container = document.getElementById('statusOptions');
                    container.innerHTML = '';
                    options.forEach(option => {
                        container.innerHTML += `
                            <div class="form-group" style="display: flex; gap: 10px; align-items: center;">
                                <input type="text" value="${option.value}" onchange="updateStatusOption('${option.id}', this.value)">
                                <button class="btn btn-danger" style="width: auto;" onclick="deleteStatusOption('${option.id}')">Sil</button>
                            </div>
                        `;
                    });
                }
            });
        }

        function loadServiceTypes() {
            const serviceRef = dbRef(db, 'serviceTypes');
            dbOnValue(serviceRef, (snapshot) => {
                const types = [];
                snapshot.forEach((child) => {
                    types.push({ id: child.key, value: child.val() });
                });
                
                if (currentUserRole === 'admin') {
                    const container = document.getElementById('serviceTypeOptions');
                    if (container) {
                        container.innerHTML = '';
                        types.forEach(type => {
                            container.innerHTML += `
                                <div class="form-group" style="display: flex; gap: 10px; align-items: center;">
                                    <input type="text" value="${type.value}" onchange="updateServiceType('${type.id}', this.value)">
                                    <button class="btn btn-danger" style="width: auto;" onclick="deleteServiceType('${type.id}')">Sil</button>
                                </div>
                            `;
                        });
                    }
                }

                const dropdown = document.getElementById('serviceTypeDropdown');
                if (dropdown) {
                    dropdown.innerHTML = types.map(t => 
                        `<div class="option-item" onclick="selectServiceType('${t.value}')">${t.value}</div>`
                    ).join('') + `
                        <div class="add-option">
                            <input type="text" id="newServiceType" placeholder="Yeni servis t√ºr√º ekle">
                            <button onclick="addNewServiceType()">Ekle</button>
                        </div>
                    `;
                }
            });
        }

        window.toggleServiceTypes = function() {
            const dropdown = document.getElementById('serviceTypeDropdown');
            dropdown.classList.toggle('active');
        };

        window.selectServiceType = function(type) {
            document.getElementById('serviceType').value = type;
            document.getElementById('serviceTypeDropdown').classList.remove('active');
        };

        window.addNewServiceType = async function() {
            const input = document.getElementById('newServiceType');
            if (input.value.trim()) {
                const serviceRef = dbRef(db, 'serviceTypes');
                const newServiceRef = dbPush(serviceRef);
                await dbSet(newServiceRef, input.value.trim());
                input.value = '';
            }
        };

        window.addStatusOption = async function() {
            const value = prompt('Yeni durum adƒ±:');
            if (value && value.trim()) {
                const statusRef = dbRef(db, 'statusOptions');
                const newStatusRef = dbPush(statusRef);
                await dbSet(newStatusRef, value.trim());
            }
        };

        window.addServiceType = async function() {
            const value = prompt('Yeni servis t√ºr√º:');
            if (value && value.trim()) {
                const serviceRef = dbRef(db, 'serviceTypes');
                const newServiceRef = dbPush(serviceRef);
                await dbSet(newServiceRef, value.trim());
            }
        };

        window.updateStatusOption = async function(id, value) {
            const statusRef = dbRef(db, `statusOptions/${id}`);
            await dbSet(statusRef, value);
        };

        window.updateServiceType = async function(id, value) {
            const serviceRef = dbRef(db, `serviceTypes/${id}`);
            await dbSet(serviceRef, value);
        };

        window.deleteStatusOption = async function(id) {
            showConfirmModal(
                'Durum Se√ßeneƒüi Silme',
                'Bu durum se√ßeneƒüini silmek istediƒüinizden emin misiniz?',
                async () => {
                    const statusRef = dbRef(db, `statusOptions/${id}`);
                    await dbRemove(statusRef);
                }
            );
        };

        window.deleteServiceType = async function(id) {
            showConfirmModal(
                'Servis T√ºr√º Silme',
                'Bu servis t√ºr√ºn√º silmek istediƒüinizden emin misiniz?',
                async () => {
                    const serviceRef = dbRef(db, `serviceTypes/${id}`);
                    await dbRemove(serviceRef);
                }
            );
        };

        function getStatusBadge(status) {
            if (status === '1. Onay Bekliyor') return 'badge-pending';
            if (status === '2. Onay Bekliyor') return 'badge-progress';
            if (status === 'Maliyet Onayƒ± Bekliyor') return 'badge-cost-pending';
            if (status === 'Onaylandƒ±') return 'badge-approved';
            if (status === 'Tamamlandƒ± - Maliyet √ñdendi') return 'badge-cost-paid';
            if (status === 'Tamamlandƒ±') return 'badge-completed';
            if (status === 'Reddedildi') return 'badge-rejected';
            return 'badge-pending';
        }

        window.switchTab = function(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        };

        window.searchRecords = function() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            document.querySelectorAll('table tbody tr').forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        };

        document.addEventListener('click', function(event) {
            if (!event.target.closest('.editable-select')) {
                document.querySelectorAll('.editable-options').forEach(dropdown => {
                    dropdown.classList.remove('active');
                });
            }
        });

        



    </script>
</body>
</html>
